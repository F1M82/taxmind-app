<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxMind ‚Äî Tax Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#1C1C2E;--ink-mid:#2E2E45;--ink-soft:#3D3D5C;
  --parchment:#F5F0E8;--parchment-dark:#EDE7D9;
  --gold:#C9960C;--gold-light:#E8B530;--gold-pale:#FDF3DC;
  --teal:#0A7E6E;--teal-light:#0FA88E;--teal-pale:#E0F5F2;
  --red:#C0392B;--red-pale:#FDECEA;
  --text:#1C1C2E;--text-mid:#5A5A7A;--text-dim:#9090A8;
  --border:#DDD8CE;--border-mid:#C8C2B5;
  --shadow:0 2px 16px rgba(28,28,46,.08);--shadow-lg:0 8px 40px rgba(28,28,46,.14);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--parchment);color:var(--text);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-mid);border-radius:3px}
.shell{display:flex;height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{width:268px;flex-shrink:0;background:var(--ink);display:flex;flex-direction:column;transition:width .3s cubic-bezier(.4,0,.2,1);overflow:hidden}
.sidebar.collapsed{width:0}
.brand{padding:22px 18px 18px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
.brand-mark{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:9px;box-shadow:0 4px 12px rgba(201,150,12,.4)}
.brand-name{font-family:'Cormorant Garamond',serif;font-size:21px;font-weight:700;color:var(--gold-light)}
.brand-sub{font-size:9.5px;color:rgba(255,255,255,.25);letter-spacing:1.4px;text-transform:uppercase;margin-top:2px}
.sidebar-scroll{flex:1;overflow-y:auto;overflow-x:hidden}
.sb-sect{padding:14px 12px 6px}
.sb-lbl{font-size:9px;font-weight:600;letter-spacing:1.8px;text-transform:uppercase;color:rgba(255,255,255,.18);padding:0 8px;margin-bottom:5px}
.sb-btn{display:flex;align-items:center;gap:10px;width:100%;padding:9px 12px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:rgba(255,255,255,.42);background:transparent;border:none;cursor:pointer;text-align:left;margin-bottom:1px;transition:all .15s;white-space:nowrap}
.sb-btn:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.72)}
.sb-btn.active{background:rgba(201,150,12,.15);color:var(--gold-light)}
.sb-btn .ic{width:18px;text-align:center;font-size:14px;flex-shrink:0}
.sb-btn .tag{margin-left:auto;font-size:9px;font-weight:700;background:var(--gold);color:var(--ink);padding:1px 6px;border-radius:10px;flex-shrink:0}

.kb-pill{margin:6px 12px 4px;padding:9px 12px;border-radius:8px;font-size:11.5px;cursor:default}
.kb-pill.ok{background:rgba(10,126,110,.12);border:1px solid rgba(10,126,110,.22)}
.kb-pill.warn{background:rgba(201,150,12,.12);border:1px solid rgba(201,150,12,.22)}
.kb-pill .kp-dot{width:5px;height:5px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.kb-pill.ok .kp-dot{background:var(--teal-light);animation:blink 2.5s infinite}
.kb-pill.warn .kp-dot{background:var(--gold-light)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.kb-pill .kp-t{font-weight:600}
.kb-pill.ok .kp-t{color:var(--teal-light)}
.kb-pill.warn .kp-t{color:var(--gold-light)}
.kb-pill .kp-s{font-size:10px;color:rgba(255,255,255,.28);margin-top:1px}

.qq-list{padding:2px 12px 12px}
.qq-item{display:block;width:100%;padding:6px 10px;background:none;border:none;text-align:left;font-family:'DM Sans',sans-serif;font-size:11px;color:rgba(255,255,255,.28);cursor:pointer;border-radius:6px;line-height:1.5;transition:all .15s;margin-bottom:1px}
.qq-item:hover{background:rgba(255,255,255,.05);color:rgba(255,255,255,.58)}
.sidebar-footer{padding:10px 14px;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
.sidebar-footer p{font-size:9.5px;color:rgba(255,255,255,.15);line-height:1.65}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:50px;background:var(--parchment);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:8px;flex-shrink:0}
.tog{width:28px;height:28px;border-radius:6px;background:transparent;border:1px solid var(--border);cursor:pointer;font-size:12px;color:var(--text-mid);display:flex;align-items:center;justify-content:center;transition:all .15s}
.tog:hover{background:var(--parchment-dark)}
.tab-row{display:flex;gap:2px;margin-left:6px}
.tab{padding:5px 13px;border-radius:6px;font-size:12.5px;font-weight:500;border:none;background:transparent;cursor:pointer;color:var(--text-mid);transition:all .15s;font-family:'DM Sans',sans-serif}
.tab:hover{background:var(--parchment-dark);color:var(--text)}
.tab.active{background:var(--ink);color:var(--gold-light)}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.green{background:var(--teal-light);box-shadow:0 0 0 2px rgba(10,200,158,.2)}
.status-dot.red{background:var(--red);animation:pulse-r 2s infinite}
.status-dot.amber{background:var(--gold-light)}
@keyframes pulse-r{0%,100%{opacity:1}50%{opacity:.4}}
.tb-label{font-size:11px;color:var(--text-mid);font-weight:500}

/* PANELS */
.panel{flex:1;overflow:hidden;display:none;flex-direction:column}
.panel.active{display:flex}

/* CHAT */
.chat-area{flex:1;overflow-y:auto;padding:16px 0 10px}
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:36px 24px;text-align:center}
.welcome-seal{width:68px;height:68px;background:linear-gradient(135deg,var(--ink),var(--ink-mid));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;margin-bottom:18px;box-shadow:0 8px 32px rgba(28,28,46,.2)}
.welcome h1{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--ink);margin-bottom:7px}
.welcome p{font-size:13.5px;color:var(--text-mid);max-width:420px;line-height:1.72;margin-bottom:6px}
.welcome .kb-notice{font-size:12px;color:var(--text-dim);margin-bottom:22px;padding:8px 16px;background:var(--gold-pale);border:1px solid #E8D088;border-radius:6px;display:inline-block}
.chips{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;max-width:540px}
.chip{padding:7px 14px;background:white;border:1px solid var(--border);border-radius:18px;font-size:11.5px;color:var(--text-mid);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.chip:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-pale)}

.msg-row{display:flex;padding:4px 12px;gap:10px;animation:msgIn .18s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user{flex-direction:row-reverse}
.av{width:28px;height:28px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;margin-top:4px}
.av.ai{background:var(--ink);color:var(--gold-light)}
.av.user{background:var(--parchment-dark);border:1px solid var(--border);font-size:11px}
.bubble{max-width:92%;padding:12px 16px;border-radius:11px;font-size:13px;line-height:1.76}
.bubble.ai{background:white;border:1px solid var(--border);color:var(--text);border-top-left-radius:3px;box-shadow:var(--shadow);width:100%}
.bubble.user{background:var(--ink);color:rgba(255,255,255,.87);border-top-right-radius:3px}
.b-meta{font-size:9.5px;color:var(--text-dim);margin-top:4px;font-family:'JetBrains Mono',monospace}
.msg-row.user .b-meta{text-align:right}
.src-tag{font-size:10px;padding:2px 7px;background:var(--gold-pale);border:1px solid #E8D088;border-radius:3px;color:#8A6A00;font-family:'JetBrains Mono',monospace;margin:3px 3px 0 0;display:inline-block}
.md h1{font-family:'Cormorant Garamond',serif;font-size:1.12rem;color:var(--ink);margin:13px 0 5px}
.md h2{font-family:'Cormorant Garamond',serif;font-size:1.02rem;color:var(--ink-mid);margin:11px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--border)}
.md h3{font-size:.88rem;font-weight:600;color:var(--ink-soft);margin:8px 0 3px}
.md p{margin:4px 0}.md ul,.md ol{padding-left:1.1rem;margin:3px 0}.md li{margin:2px 0}
.md strong{font-weight:600;color:var(--ink)}.md em{color:var(--ink-soft)}
.md code{font-family:'JetBrains Mono',monospace;font-size:.78rem;background:var(--parchment-dark);padding:1px 5px;border-radius:3px;color:var(--gold)}
.md table{width:100%;border-collapse:collapse;margin:5px 0;font-size:.83rem}
.md th{background:var(--ink);color:var(--gold-light);padding:6px 10px;text-align:left}
.md td{padding:5px 10px;border:1px solid var(--border)}
.md tr:nth-child(even) td{background:var(--parchment)}
.md blockquote{border-left:3px solid var(--gold);padding-left:10px;color:var(--text-mid);margin:5px 0;font-style:italic}
.md hr{border:none;border-top:1px solid var(--border);margin:7px 0}
.typing{display:flex;gap:5px;padding:12px 16px;background:white;border:1px solid var(--border);border-radius:11px;border-top-left-radius:3px;box-shadow:var(--shadow);align-items:center}
.dot{width:6px;height:6px;background:var(--gold);border-radius:50%;animation:dots 1.2s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes dots{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.input-bar{padding:12px 18px 16px;background:var(--parchment);border-top:1px solid var(--border);flex-shrink:0}
.input-wrap{display:flex;gap:8px;align-items:flex-end;background:white;border:1.5px solid var(--border);border-radius:11px;padding:8px 9px 8px 15px;transition:border-color .2s;box-shadow:var(--shadow)}
.input-wrap:focus-within{border-color:var(--gold)}
.input-ta{flex:1;background:transparent;border:none;outline:none;resize:none;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);line-height:1.5;max-height:110px;overflow-y:auto}
.input-ta::placeholder{color:var(--text-dim)}
.send-btn{width:32px;height:32px;border-radius:7px;flex-shrink:0;background:linear-gradient(135deg,var(--gold),var(--gold-light));border:none;cursor:pointer;font-size:13px;color:var(--ink);display:flex;align-items:center;justify-content:center;font-weight:700;transition:all .15s;box-shadow:0 2px 8px rgba(201,150,12,.3)}
.send-btn:hover{transform:scale(1.07)}.send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}
.input-hint{font-size:10px;color:var(--text-dim);text-align:center;margin-top:6px}

/* CONTENT PANELS */
.cpanel{flex:1;overflow-y:auto;padding:22px}
.ptitle{font-family:'Cormorant Garamond',serif;font-size:21px;font-weight:700;color:var(--ink);margin-bottom:5px}
.psub{font-size:12.5px;color:var(--text-mid);line-height:1.65;margin-bottom:18px}
.icards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px}
.icard{background:white;border:1px solid var(--border);border-radius:9px;padding:13px 14px;box-shadow:var(--shadow)}
.icard .ci{font-size:17px;margin-bottom:5px}
.icard .cl{font-size:9.5px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.icard .cv{font-size:11.5px;color:var(--text-mid);line-height:1.4}
.bta{width:100%;min-height:220px;background:white;border:1.5px solid var(--border);border-radius:9px;padding:14px;font-family:'DM Sans',sans-serif;font-size:12.5px;color:var(--text);resize:vertical;outline:none;line-height:1.65;transition:border-color .2s;box-shadow:var(--shadow)}
.bta:focus{border-color:var(--gold)}.bta::placeholder{color:var(--text-dim)}
.arow{display:flex;gap:9px;margin-top:11px;align-items:center;flex-wrap:wrap}
.pbtn{padding:10px 22px;border-radius:7px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;background:linear-gradient(135deg,var(--ink),var(--ink-mid));color:var(--gold-light);transition:all .15s;box-shadow:0 3px 12px rgba(28,28,46,.22)}
.pbtn:hover{transform:translateY(-1px)}.pbtn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.gbtn{padding:10px 16px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--text-mid);font-size:12.5px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.gbtn:hover{background:var(--parchment-dark)}
.warn-note{font-size:10.5px;color:var(--text-dim);margin-top:8px}
.notice-sum{background:var(--gold-pale);border:1px solid #E8D088;border-radius:9px;padding:14px 16px;margin-bottom:14px}
.notice-sum h3{font-size:11.5px;font-weight:600;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:9px}
.nsg{display:grid;grid-template-columns:1fr 1fr;gap:5px 14px}
.nsi .nsk{font-size:10px;color:var(--text-dim);margin-bottom:1px}
.nsi .nsv{font-size:12px;font-weight:500;color:var(--ink)}
.ubadge{display:inline-block;padding:2px 8px;background:var(--red-pale);border:1px solid var(--red);border-radius:4px;font-size:10.5px;font-weight:700;color:var(--red);margin-left:5px}

/* KB PANEL */
.kstats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
.scard{background:white;border:1px solid var(--border);border-radius:9px;padding:13px 15px;box-shadow:var(--shadow)}
.scard .sn{font-size:21px;font-family:'Cormorant Garamond',serif;font-weight:700;color:var(--ink)}
.scard .sl{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-top:1px}

.sync-bar{background:white;border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow)}
.sync-bar .sb-info{flex:1}
.sync-bar .sb-title{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:2px}
.sync-bar .sb-sub{font-size:11px;color:var(--text-mid)}
.sync-btn{padding:8px 18px;border-radius:7px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:600;background:linear-gradient(135deg,var(--teal),var(--teal-light));color:white;transition:all .15s;box-shadow:0 2px 8px rgba(10,126,110,.25);flex-shrink:0}
.sync-btn:hover{transform:translateY(-1px)}.sync-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

.upload-form{background:white;border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:18px;box-shadow:var(--shadow)}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.fg label{display:block;font-size:10.5px;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.fi,.fs{width:100%;padding:7px 11px;background:var(--parchment);border:1px solid var(--border);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:12.5px;color:var(--text);outline:none;transition:border-color .15s}
.fi:focus,.fs:focus{border-color:var(--gold);background:white}
.ubox{background:var(--parchment);border:1.5px dashed var(--border-mid);border-radius:8px;padding:18px;text-align:center;cursor:pointer;transition:all .2s;margin-top:12px}
.ubox:hover,.ubox.drag{border-color:var(--gold);background:var(--gold-pale)}
.ubox .ui{font-size:26px;margin-bottom:7px}
.ubox .ut{font-size:13px;font-weight:600;color:var(--ink);margin-bottom:3px}
.ubox .us{font-size:11px;color:var(--text-mid)}
.pbar{height:3px;background:var(--parchment-dark);border-radius:3px;overflow:hidden;margin-top:7px}
.pfill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-light));border-radius:3px;transition:width .3s}

.doc-list{display:flex;flex-direction:column;gap:7px}
.drow{background:white;border:1px solid var(--border);border-radius:8px;padding:11px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow)}
.drow .di{font-size:17px;flex-shrink:0}
.drow .dinfo{flex:1;min-width:0}
.drow .dt{font-size:12.5px;font-weight:500;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.drow .dm{font-size:10.5px;color:var(--text-dim);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap}
.drow .dc{font-size:10.5px;padding:2px 7px;background:var(--gold-pale);color:var(--gold);border-radius:3px;font-weight:500;flex-shrink:0}
.drow .ddel{background:none;border:1px solid var(--border);border-radius:5px;padding:3px 9px;color:var(--text-dim);font-size:10.5px;cursor:pointer;transition:all .15s;flex-shrink:0}
.drow .ddel:hover{border-color:var(--red);color:var(--red)}
.src-badge{font-size:9.5px;padding:2px 6px;border-radius:3px;font-weight:500;flex-shrink:0}
.src-badge.shared{background:var(--teal-pale);color:var(--teal)}
.src-badge.local{background:var(--gold-pale);color:var(--gold)}

.cr-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.spills{display:flex;flex-wrap:wrap;gap:5px;margin-top:14px}
.sp{padding:4px 11px;background:white;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--ink-soft);cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.sp:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-pale)}
.empty-st{text-align:center;padding:36px 20px;color:var(--text-dim);font-size:12.5px}
.empty-st .esi{font-size:34px;margin-bottom:9px}

/* MODAL */
.mo{position:fixed;inset:0;background:rgba(28,28,46,.72);backdrop-filter:blur(7px);display:flex;align-items:center;justify-content:center;z-index:1000}
.mb{background:white;border-radius:15px;padding:28px;width:440px;max-width:92vw;box-shadow:var(--shadow-lg);animation:mIn .22s ease}
@keyframes mIn{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
.mb-ico{font-size:34px;text-align:center;margin-bottom:12px}
.mb h2{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--ink);text-align:center;margin-bottom:5px}
.mb p{font-size:12.5px;color:var(--text-mid);line-height:1.65;text-align:center;margin-bottom:18px}
.mi{width:100%;padding:10px 14px;background:var(--parchment);border:1.5px solid var(--border);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:12.5px;color:var(--text);outline:none;margin-bottom:9px}
.mi:focus{border-color:var(--gold);background:white}
.mb-btn{width:100%;padding:11px;border-radius:8px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13.5px;font-weight:600;background:linear-gradient(135deg,var(--ink),var(--ink-mid));color:var(--gold-light);margin-bottom:7px;transition:all .15s}
.mb-btn:hover{opacity:.9}
.mb-note{font-size:10.5px;color:var(--text-dim);text-align:center;line-height:1.55}
.toast{position:fixed;bottom:20px;right:20px;background:white;border:1px solid var(--border);border-radius:9px;padding:11px 16px;font-size:12.5px;color:var(--text);z-index:2000;box-shadow:var(--shadow-lg);animation:tIn .25s ease;max-width:300px;border-left-width:3px}
@keyframes tIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- SETUP MODAL (shown when KB is empty on first visit) -->
<div class="mo" id="setupModal" style="display:none">
  <div class="mb">
    <div class="mb-ico">‚öñÔ∏è</div>
    <h2>TaxMind ‚Äî First Setup</h2>
    <p>The knowledge base is empty. Go to the <strong>Knowledge Base</strong> tab to upload your Income Tax Act 2025 PDF. Once indexed, all team members will have access automatically.</p>
    <button class="mb-btn" onclick="closeSetup()">Open Knowledge Base ‚Üí</button>
    <p class="mb-note">This message only appears when the shared KB has no documents.</p>
  </div>
</div>

<div class="shell">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-mark">‚öñÔ∏è</div>
      <div class="brand-name">TaxMind</div>
      <div class="brand-sub">Tax Intelligence ¬∑ Team</div>
    </div>
    <div class="sidebar-scroll">
      <div class="sb-sect">
        <div class="sb-lbl">Workspace</div>
        <button class="sb-btn active" onclick="sw('chat')" id="sb-chat"><span class="ic">üí¨</span>Tax Query</button>
        <button class="sb-btn" onclick="sw('notice')" id="sb-notice"><span class="ic">üìã</span>Notice Analyzer<span class="tag">KEY</span></button>
        <button class="sb-btn" onclick="sw('crossref')" id="sb-crossref"><span class="ic">üîÄ</span>Section Cross-Ref</button>
        <button class="sb-btn" onclick="sw('kb')" id="sb-kb"><span class="ic">üìö</span>Knowledge Base</button>
      </div>
      <!-- KB Status -->
      <div class="kb-pill warn" id="kbPill">
        <div><span class="kp-dot"></span><span class="kp-t" id="kbPillTitle">Loading KB‚Ä¶</span></div>
        <div class="kp-s" id="kbPillSub">Shared with team</div>
      </div>
      <div class="sb-sect"><div class="sb-lbl">Quick Queries</div></div>
      <div class="qq-list" id="qqList"></div>
    </div>
    <div class="sidebar-footer"><p>‚öñ ITA 2025 ¬∑ Effective 1 Apr 2026<br>Shared Knowledge Base ¬∑ Team Edition<br>Powered by Claude Sonnet 4</p></div>
  </div>

  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <button class="tog" onclick="toggleSb()">‚ò∞</button>
      <div class="tab-row">
        <button class="tab active" onclick="sw('chat')" id="tab-chat">Chat</button>
        <button class="tab" onclick="sw('notice')" id="tab-notice">Notice Draft</button>
        <button class="tab" onclick="sw('crossref')" id="tab-crossref">Cross-Ref</button>
        <button class="tab" onclick="sw('kb')" id="tab-kb">Knowledge Base</button>
      </div>
      <div class="tb-right">
        <div class="status-dot red" id="kbDot"></div>
        <span class="tb-label" id="kbLabel">Loading‚Ä¶</span>
      </div>
    </div>

    <!-- CHAT -->
    <div class="panel active" id="panel-chat">
      <div class="chat-area" id="chatArea">
        <div class="welcome" id="welcomeScr">
          <div class="welcome-seal">‚öñÔ∏è</div>
          <h1>TaxMind is Ready</h1>
          <p>Your firm's AI assistant for the new Income Tax Act 2025. Every answer cites both the new and old Act sections.</p>
          <div class="kb-notice" id="kbNotice">‚úÖ Ready ‚Äî ask your tax question below</div>
          <div class="chips" id="chips"></div>
        </div>
      </div>
      <div class="input-bar">
        <div class="input-wrap">
          <textarea class="input-ta" id="chatInput" rows="1" placeholder="Ask anything about Income Tax Act 2025‚Ä¶" onkeydown="hkey(event)" oninput="resize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendChat()" disabled>‚Üë</button>
        </div>
        <div class="input-hint" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">
          <span>Enter to send ¬∑ Shift+Enter new line</span>
          <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:11px;color:var(--text-dim)">
            <input type="checkbox" id="webToggle" checked onchange="toggleWeb(this)" style="accent-color:var(--teal)"/>
            üåê Web search
          </label>
        </div>
      </div>
    </div>

    <!-- NOTICE -->
    <div class="panel" id="panel-notice">
      <div class="cpanel">
        <div class="ptitle">üìã Notice Analyzer & Draft Reply</div>
        <div class="psub">Paste any income tax notice. TaxMind extracts details and generates a complete draft reply with legal submissions and case law citations.</div>
        <div class="icards">
          <div class="icard"><div class="ci">üìÑ</div><div class="cl">Notice Types</div><div class="cv">143(1), 148, 148A, 154, 156, 263, 271 & all standard types</div></div>
          <div class="icard"><div class="ci">‚ö°</div><div class="cl">Output</div><div class="cv">Complete draft ‚Äî grounds, legal submissions, case laws, prayer</div></div>
          <div class="icard"><div class="ci">üîí</div><div class="cl">Confidentiality</div><div class="cv">Replace client name & PAN with [CLIENT NAME] and [PAN]</div></div>
        </div>
        <textarea class="bta" id="noticeInput" placeholder="Paste notice content here...&#10;&#10;Example:&#10;F.No. ITO/Ward-3/2025-26/1234 | Date: 15-01-2026&#10;To: [CLIENT NAME], PAN: [PAN]&#10;Sub: Notice u/s 148A(b) for AY 2022-23&#10;You are hereby required to show cause..."></textarea>
        <div class="arow">
          <button class="pbtn" id="analyzeBtn" onclick="analyzeNotice()">‚ö° Analyze & Draft Reply</button>
          <button class="gbtn" onclick="document.getElementById('noticeInput').value=''">Clear</button>
        </div>
        <div class="warn-note">‚ö† Replace actual client name and PAN before pasting.</div>
        <div id="noticeResult" style="margin-top:20px;display:none">
          <div class="notice-sum" id="noticeSumCard"></div>
          <div style="background:white;border:1px solid var(--border);border-radius:9px;padding:18px;box-shadow:var(--shadow)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <div style="font-weight:600;font-size:13.5px;color:var(--ink)">üìù Draft Reply</div>
              <button class="gbtn" onclick="copyDraft()" style="font-size:11.5px;padding:5px 12px">Copy</button>
            </div>
            <div id="draftContent" class="md" style="font-size:12.5px;line-height:1.82;color:var(--text)"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CROSSREF -->
    <div class="panel" id="panel-crossref">
      <div class="cpanel">
        <div class="ptitle">üîÄ Section Cross-Reference</div>
        <div class="psub">Enter an old Act section number or topic keyword for a side-by-side comparison with the new ITA 2025.</div>
        <div class="cr-grid">
          <div class="fg"><label>Old Act Section (ITA 1961)</label><input class="fi" id="crSec" placeholder="e.g. 80C, 148, 10(38)" onkeydown="if(event.key==='Enter')lookup()" style="font-family:'JetBrains Mono',monospace;font-size:14px"/></div>
          <div class="fg"><label>Or Search by Topic</label><input class="fi" id="crKw" placeholder="e.g. capital gains, TDS, deduction" onkeydown="if(event.key==='Enter')lookup()"/></div>
        </div>
        <button class="pbtn" onclick="lookup()">Look Up ‚Üí</button>
        <div style="margin-top:20px"><div style="font-size:10px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px">Common Sections</div><div class="spills" id="spills"></div></div>
        <div id="crResult" style="margin-top:20px;display:none">
          <div style="background:white;border:1px solid var(--border);border-radius:9px;padding:18px;box-shadow:var(--shadow)">
            <div id="crContent" class="md" style="font-size:12.5px;line-height:1.8"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- KB -->
    <div class="panel" id="panel-kb">
      <div class="cpanel">
        <div class="ptitle">üìö Knowledge Base</div>
        <div class="psub">Upload documents below ‚Äî they're shared with your entire team instantly. Stored centrally; no one needs to upload individually.</div>
        <div class="kstats">
          <div class="scard"><div class="sn" id="stDocs">‚Äî</div><div class="sl">Shared Docs</div></div>
          <div class="scard"><div class="sn" id="stChunks">‚Äî</div><div class="sl">Text Chunks</div></div>
          <div class="scard"><div class="sn" id="stLocal">0</div><div class="sl">Local Only</div></div>
          <div class="scard"><div class="sn" id="stSize">‚Äî</div><div class="sl">Storage</div></div>
        </div>

        <!-- Sync bar -->
        <div class="sync-bar">
          <div class="sb-info">
            <div class="sb-title">üîÑ Shared Knowledge Base</div>
            <div class="sb-sub" id="lastSync">Click Sync to load the latest documents from the server</div>
          </div>
          <button class="sync-btn" id="syncBtn" onclick="syncKB()">Sync Now</button>
        </div>

        <!-- Upload form -->
        <div class="upload-form">
          <div style="font-size:13.5px;font-weight:600;color:var(--ink);margin-bottom:13px">üì§ Add Document (shared with team)</div>
          <div class="fgrid">
            <div class="fg"><label>Title *</label><input class="fi" id="docTitle" placeholder="e.g. Income Tax Act 2025"/></div>
            <div class="fg"><label>Category *</label>
              <select class="fs" id="docCat" onchange="toggleCL()">
                <option>New Act</option><option>Old Act</option><option>Rules</option>
                <option>CBDT Circular</option><option>Notification</option><option>Finance Act</option>
                <option>Case Law</option><option>ITAT Order</option><option>Section Mapping</option><option>Internal Notes</option>
              </select>
            </div>
            <div class="fg"><label>Sections</label><input class="fi" id="docSec" placeholder="e.g. 80C, 148"/></div>
            <div class="fg"><label>Tags</label><input class="fi" id="docTags" placeholder="e.g. deduction, capital gains"/></div>
            <div class="fg" id="clCite" style="display:none"><label>Citation</label><input class="fi" id="docCite" placeholder="(2024) 465 ITR 210 (Del)"/></div>
            <div class="fg" id="clCourt" style="display:none"><label>Court</label><input class="fi" id="docCourt" placeholder="Delhi HC / ITAT Mumbai"/></div>
            <div class="fg" id="clOut" style="display:none"><label>Outcome</label>
              <select class="fs" id="docOut">
                <option value="">Select...</option>
                <option value="taxpayer_favorable">Taxpayer Favorable ‚úì</option>
                <option value="revenue_favorable">Revenue Favorable</option>
                <option value="mixed">Mixed</option>
              </select>
            </div>
          </div>
          <input type="file" id="fileIn" accept=".pdf,.txt,.md" style="display:none" onchange="fileSel(this)"/>
          <div class="ubox" id="ubox" onclick="document.getElementById('fileIn').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="fileDrop(event)">
            <div class="ui">üìÑ</div>
            <div class="ut">Click to select or drag & drop</div>
            <div class="us" id="uboxSub">PDF or TXT ¬∑ Max 25MB</div>
          </div>
          <div id="upProg" style="display:none;margin-top:9px">
            <div style="font-size:11.5px;color:var(--text-mid);margin-bottom:4px" id="progLbl">Processing...</div>
            <div class="pbar"><div class="pfill" id="pFill" style="width:0%"></div></div>
          </div>
          <button class="pbtn" style="margin-top:12px;width:100%" id="idxBtn" onclick="indexDoc()">üì§ Index & Share with Team</button>
        </div>

        <div style="font-size:10.5px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:9px" id="dlLabel">Documents (0)</div>
        <div class="doc-list" id="docList"><div class="empty-st"><div class="esi">üì≠</div>No documents yet. Upload your ITA 2025 PDF above.</div></div>
      </div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let msgs=[];
let sharedKB=[];   // from server
let localKB=[];    // local uploads not yet indexed
let selFile=null;

try{localKB=JSON.parse(localStorage.getItem('tm_local_kb')||'[]');}catch(e){localKB=[];}

const KB=()=>[...sharedKB,...localKB];
const MODEL='claude-sonnet-4-20250514';
const QQ=['What replaces Section 80C in the new Act?','Compare Section 148 reassessment old vs new','New TDS rates under ITA 2025','Capital gains changes in new Act','Section 68 unexplained cash credit ‚Äî what changed?','New presumptive taxation ‚Äî 44AD equivalent'];
const SECS=['80C','80D','10(38)','148','148A','147','263','68','69A','54','54F','24(b)','44AD','44ADA','115BAC','271AAB'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  renderQQ(); renderPills();
  // Show app immediately, load KB in background
  updateKBUI(); // render UI with empty KB first
  setTimeout(async()=>{
    await syncKB(true);
    loadChunksBackground();
  }, 100);
});

// ‚îÄ‚îÄ SHARED KB SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncKB(silent=false){
  if(!silent){
    document.getElementById('syncBtn').disabled=true;
    document.getElementById('syncBtn').textContent='Syncing‚Ä¶';
  }
  try{
    // Load metadata only ‚Äî instant
    const res=await fetch('/api/kb');
    if(!res.ok) throw new Error('Server error '+res.status);
    const data=await res.json();
    if(data.documents){
      sharedKB=data.documents.map(d=>({...d,chunks:[]}));
      _index=null; _indexedKBLen=0; chunksLoaded=false;
      updateKBUI();
      const notice=document.getElementById('kbNotice');
      if(sharedKB.length>0){
        if(notice) notice.textContent=`‚úÖ ${sharedKB.length} document${sharedKB.length>1?'s':''} found ‚Äî loading chunks in background‚Ä¶`;
      }
      if(!silent) showToast(`Synced ‚Äî ${sharedKB.length} docs ready`,'success');
      if(!silent) loadChunksBackground();
    }
  }catch(e){
    if(!silent) showToast('Sync failed: '+e.message,'error');
    updateKBUI();
  }
  if(!silent){
    document.getElementById('syncBtn').disabled=false;
    document.getElementById('syncBtn').textContent='Sync Now';
  }
}

// ‚îÄ‚îÄ CHUNK CACHE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chunksLoaded=false;
let chunksLoading=false;
const CACHE_KEY='tm_chunks_cache';
const CACHE_VER_KEY='tm_chunks_ver';

async function getCacheVersion(){
  // Version = sorted doc IDs + chunkCounts joined
  return sharedKB.map(d=>d.id+':'+d.chunkCount).sort().join('|');
}

async function loadChunksBackground(){
  if(chunksLoaded||chunksLoading) return;
  chunksLoading=true;
  try{
    // Check localStorage cache first
    const ver = await getCacheVersion();
    const cachedVer = localStorage.getItem(CACHE_VER_KEY);
    const cachedData = localStorage.getItem(CACHE_KEY);
    if(cachedVer===ver && cachedData){
      const docs = JSON.parse(cachedData);
      sharedKB = docs;
      _index=null; _indexedKBLen=0;
      chunksLoaded=true;
      chunksLoading=false;
      document.getElementById('kbLabel').textContent=`${sharedKB.length} docs ¬∑ ready`;
      return;
    }
    // Fetch from server
    document.getElementById('kbLabel').textContent='Loading chunks‚Ä¶';
    const res=await fetch('/api/kb?chunks=1');
    if(!res.ok) throw new Error('chunks load failed '+res.status);
    const data=await res.json();
    if(data.documents){
      sharedKB=data.documents;
      _index=null; _indexedKBLen=0;
      chunksLoaded=true;
      // Save to localStorage cache
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify(sharedKB));
        localStorage.setItem(CACHE_VER_KEY, ver);
      }catch(e){ console.warn('cache save failed',e); }
      document.getElementById('kbLabel').textContent=`${sharedKB.length} docs ¬∑ ready`;
    }
  }catch(e){
    console.warn('chunk load error',e);
    document.getElementById('kbLabel').textContent='Chunks load failed ‚Äî retry';
  }
  chunksLoading=false;
}

async function ensureChunks(){
  if(chunksLoaded) return;
  if(!chunksLoading) loadChunksBackground();
  // Wait for chunks to load (max 30s)
  let tries=0;
  while(!chunksLoaded && tries<60){
    await new Promise(r=>setTimeout(r,500));
    tries++;
  }
}

async function pushToServer(docs){
  try{
    const PAGE = 50;
    for(const doc of docs){
      const allChunks = doc.chunks || [];
      const totalPages = Math.ceil(allChunks.length / PAGE);
      
      for(let p = 0; p < totalPages; p++){
        const pageChunks = allChunks.slice(p * PAGE, (p+1) * PAGE);
        const isFirst = p === 0;
        const payload = JSON.stringify({documents:[{
          ...doc,
          chunks: pageChunks,
          chunkCount: allChunks.length, // always send total count
          chunkPage: p,
          totalPages
        }]});
        
        document.getElementById('progLbl').textContent=
          `Uploading page ${p+1}/${totalPages} (${allChunks.length} total chunks)‚Ä¶`;
        document.getElementById('pFill').style.width = (92 + (8*(p+1)/totalPages)) + '%';
        
        const res = await fetch('/api/kb', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: payload
        });
        const responseText = await res.text();
        let data;
        try { data = JSON.parse(responseText); }
        catch(e) { throw new Error('Bad response p'+p+': '+responseText.slice(0,100)); }
        if(!res.ok) throw new Error('Server '+res.status+' p'+p+': '+(data.error||'unknown'));
        if(!data.ok) throw new Error('KB error p'+p+': '+(data.error||JSON.stringify(data)));
      }
    }
    return true;
  }catch(e){
    showToast('Upload failed: '+e.message,'error');
    console.error('pushToServer error:', e);
    return false;
  }
}

async function deleteFromServer(id){
  try{
    await fetch('/api/kb?id='+id,{method:'DELETE'});
  }catch(e){ console.warn('Delete sync failed',e); }
}

// ‚îÄ‚îÄ KB UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateKBUI(){
  const all=KB();
  const total=all.length;
  const totalChunks=all.reduce((s,d)=>s+(d.chunkCount||0),0);
  const totalSize=all.reduce((s,d)=>s+(d.size||0),0);

  document.getElementById('stDocs').textContent=sharedKB.length;
  document.getElementById('stChunks').textContent=totalChunks.toLocaleString()||'‚Äî';
  document.getElementById('stLocal').textContent=localKB.length;
  document.getElementById('stSize').textContent=totalSize>1048576?(totalSize/1048576).toFixed(1)+' MB':Math.round(totalSize/1024)+' KB';
  document.getElementById('dlLabel').textContent=`Documents (${total})`;

  // Sidebar pill
  const pill=document.getElementById('kbPill');
  const dot=document.getElementById('kbDot');
  const lbl=document.getElementById('kbLabel');
  const notice=document.getElementById('kbNotice');

  if(total>0){
    pill.className='kb-pill ok';
    document.getElementById('kbPillTitle').textContent='KB Ready';
    document.getElementById('kbPillSub').textContent=`${total} doc${total>1?'s':''} ¬∑ shared`;
    dot.className='status-dot green';
    lbl.textContent=`${total} doc${total>1?'s':''} ¬∑ ready`;
    if(notice) notice.textContent=`‚úÖ ${total} document${total>1?'s':''} loaded ‚Äî answers grounded in your materials`;
    document.getElementById('sendBtn').disabled=!document.getElementById('chatInput').value.trim();
  }else{
    pill.className='kb-pill warn';
    document.getElementById('kbPillTitle').textContent='KB Empty';
    document.getElementById('kbPillSub').textContent='Upload ITA 2025 PDF';
    dot.className='status-dot amber';
    lbl.textContent='KB empty ‚Äî upload docs';
    if(notice) notice.textContent='‚ö†Ô∏è Knowledge base empty ‚Äî go to Knowledge Base tab to upload ITA 2025 PDF';
  }

  renderDocList();
  document.getElementById('lastSync').textContent='Last synced: '+new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

function renderDocList(){
  const all=KB();
  const list=document.getElementById('docList');
  if(!all.length){list.innerHTML='<div class="empty-st"><div class="esi">üì≠</div>No documents yet. Upload your ITA 2025 PDF above.</div>';return;}
  const ic={'New Act':'üìó','Old Act':'üìò','Case Law':'‚öñÔ∏è','ITAT Order':'üèõ','CBDT Circular':'üìú','Section Mapping':'üîÄ','Internal Notes':'üìù'};
  list.innerHTML=all.map(d=>`
    <div class="drow">
      <div class="di">${ic[d.category]||'üìÑ'}</div>
      <div class="dinfo">
        <div class="dt">${d.title}</div>
        <div class="dm">
          ${d.chunkCount?`<span>${d.chunkCount} chunks</span>`:''}
          ${d.sections?`<span>s. ${d.sections}</span>`:''}
          ${d.citation?`<span>${d.citation}</span>`:''}
          <span>${new Date(d.addedAt).toLocaleDateString('en-IN')}</span>
        </div>
      </div>
      <span class="src-badge ${localKB.find(x=>x.id===d.id)?'local':'shared'}">${localKB.find(x=>x.id===d.id)?'Local':'Shared'}</span>
      <div class="dc">${d.category}</div>
      <button class="ddel" onclick="delDoc('${d.id}')">Delete</button>
    </div>`).join('');
}

async function delDoc(id){
  if(!confirm('Remove this document from the shared knowledge base?'))return;
  sharedKB=sharedKB.filter(d=>d.id!==id);
  localKB=localKB.filter(d=>d.id!==id);
  saveLocal();
  await deleteFromServer(id);
  updateKBUI();
  showToast('Document removed','info');
}

function saveLocal(){
  try{localStorage.setItem('tm_local_kb',JSON.stringify(localKB));}catch(e){}
}

// ‚îÄ‚îÄ DOCUMENT INDEXING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCL(){
  const isCL=['Case Law','ITAT Order'].includes(document.getElementById('docCat').value);
  ['clCite','clCourt','clOut'].forEach(id=>document.getElementById(id).style.display=isCL?'block':'none');
}
function fileSel(i){if(i.files[0]){selFile=i.files[0];document.getElementById('uboxSub').textContent='Selected: '+selFile.name;}}
function fileDrop(e){e.preventDefault();document.getElementById('ubox').classList.remove('drag');if(e.dataTransfer.files[0]){selFile=e.dataTransfer.files[0];document.getElementById('uboxSub').textContent='Selected: '+selFile.name;}}

async function extractPDF(file){
  const ab=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:ab}).promise;
  let text='';
  for(let i=1;i<=pdf.numPages;i++){
    const pg=await pdf.getPage(i);
    const c=await pg.getTextContent();
    text+=c.items.map(x=>x.str).join(' ')+'\n';
    document.getElementById('pFill').style.width=Math.round(i/pdf.numPages*70)+'%';
    document.getElementById('progLbl').textContent=`Extracting page ${i} of ${pdf.numPages}‚Ä¶`;
  }
  return text;
}

function chunk(text){
  const s=text.replace(/\n+/g,' ').split(/(?<=[.!?])\s+/);
  const out=[];let cur=[];let len=0;
  for(const x of s){if(len+x.length>1500&&cur.length){out.push(cur.join(' '));cur=cur.slice(-2);len=cur.reduce((a,c)=>a+c.length,0);}cur.push(x);len+=x.length;}
  if(cur.length)out.push(cur.join(' '));
  return out.filter(c=>c.trim().length>50);
}

async function indexDoc(){
  const title=document.getElementById('docTitle').value.trim();
  const cat=document.getElementById('docCat').value;
  if(!title){showToast('Enter a document title','error');return;}
  if(!selFile){showToast('Select a file','error');return;}
  if(selFile.size>25*1024*1024){showToast('File too large ‚Äî max 25MB','error');return;}
  document.getElementById('idxBtn').disabled=true;
  document.getElementById('upProg').style.display='block';
  document.getElementById('pFill').style.width='5%';
  document.getElementById('progLbl').textContent='Reading‚Ä¶';
  try{
    let text=selFile.name.toLowerCase().endsWith('.pdf')?await extractPDF(selFile):await selFile.text();
    document.getElementById('progLbl').textContent='Chunking‚Ä¶';
    document.getElementById('pFill').style.width='80%';
    const chunks=chunk(text);
    document.getElementById('progLbl').textContent='Uploading to shared KB‚Ä¶';
    document.getElementById('pFill').style.width='92%';
    const doc={
      id:Date.now().toString(),title,category:cat,filename:selFile.name,
      sections:document.getElementById('docSec').value,tags:document.getElementById('docTags').value,
      citation:document.getElementById('docCite').value,court:document.getElementById('docCourt').value,
      outcome:document.getElementById('docOut').value,
      chunks,chunkCount:chunks.length,size:selFile.size,addedAt:new Date().toISOString()
    };
    const ok=await pushToServer([doc]);
    if(ok){
      sharedKB.push(doc);
      document.getElementById('pFill').style.width='100%';
      document.getElementById('progLbl').textContent=`‚úÖ Shared with team ‚Äî ${chunks.length} chunks`;
      showToast(`‚úÖ "${title}" shared with team!`,'success');
    }else{
      // Fallback: local only
      localKB.push(doc); saveLocal();
      document.getElementById('progLbl').textContent=`‚úÖ Saved locally ‚Äî ${chunks.length} chunks`;
      showToast(`Saved locally (server unavailable)`,'info');
    }
    updateKBUI();
    setTimeout(()=>{document.getElementById('upProg').style.display='none';document.getElementById('pFill').style.width='0%';},2000);
    selFile=null;document.getElementById('fileIn').value='';
    document.getElementById('uboxSub').textContent='PDF or TXT ¬∑ Max 25MB';
    document.getElementById('docTitle').value='';
  }catch(e){showToast('Indexing failed: '+e.message,'error');}
  document.getElementById('idxBtn').disabled=false;
}

// ‚îÄ‚îÄ BM25 SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Based on BM25 algorithm - no embeddings, no cosine similarity
// Field-weighted: section numbers > headings > body text

const BM25_K1 = 1.5;
const BM25_B  = 0.75;

function tokenize(t){
  return t.toLowerCase()
    .replace(/[^a-z0-9\s]/g,' ')
    .split(/\s+/)
    .filter(w => w.length > 1);
}

function extractSectionNums(t){
  // Extract patterns like 192, 194A, 80C, 148A(b) etc.
  const nums = [];
  const m1 = t.match(/(?:section|sec\.?|s\.)\s*([0-9]+[a-z]*)/gi) || [];
  m1.forEach(x => { const n = x.match(/([0-9]+[a-z]*)/i); if(n) nums.push(n[1].toLowerCase()); });
  const m2 = t.match(/\b([0-9]{2,3}[a-zA-Z]{0,3})\b/g) || [];
  m2.forEach(x => nums.push(x.toLowerCase()));
  return [...new Set(nums)];
}

// Build BM25 index from all chunks
function buildIndex(docs){
  const index = { chunks:[], df:{}, avgLen:0 };
  let totalLen = 0;
  docs.forEach(doc => {
    (doc.chunks||[]).forEach(c => {
      const tokens = tokenize(c);
      const tf = {};
      tokens.forEach(t => { tf[t] = (tf[t]||0) + 1; });
      index.chunks.push({ text:c, doc, tf, len:tokens.length, secs: extractSectionNums(c) });
      totalLen += tokens.length;
      Object.keys(tf).forEach(t => { index.df[t] = (index.df[t]||0) + 1; });
    });
  });
  index.avgLen = totalLen / (index.chunks.length || 1);
  index.N = index.chunks.length;
  return index;
}

let _index = null;
let _indexedKBLen = 0;

function getIndex(){
  const all = KB();
  const totalChunks = all.reduce((s,d) => s + (d.chunks||[]).length, 0);
  if(!_index || _indexedKBLen !== totalChunks){
    _index = buildIndex(all);
    _indexedKBLen = totalChunks;
  }
  return _index;
}

function bm25score(chunk, queryTokens, qSecs, index){
  let score = 0;
  const N = index.N;
  const avgLen = index.avgLen;

  queryTokens.forEach(qt => {
    const df = index.df[qt] || 0;
    if(!df) return;
    const idf = Math.log((N - df + 0.5) / (df + 0.5) + 1);
    const tf = chunk.tf[qt] || 0;
    const norm = tf * (BM25_K1 + 1) / (tf + BM25_K1 * (1 - BM25_B + BM25_B * chunk.len / avgLen));
    score += idf * norm;
  });

  // Strong boost for section number matches
  if(qSecs.length){
    const matches = qSecs.filter(s => chunk.secs.includes(s));
    score += matches.length * 8.0; // heavy boost - section match is highly relevant
  }

  return score;
}

function getCtx(q, k=8){
  const all = KB();
  if(!all.length) return '';
  const index = getIndex();
  const qTokens = tokenize(q);
  const qSecs = extractSectionNums(q);

  const scored = index.chunks.map(chunk => ({
    chunk,
    score: bm25score(chunk, qTokens, qSecs, index)
  }));

  scored.sort((a,b) => b.score - a.score);

  // Deduplicate ‚Äî take best chunk per doc first, then fill remaining slots
  const seen = new Set();
  const results = [];
  // First pass: best from each doc
  const byDoc = {};
  scored.forEach(({chunk, score}) => {
    const id = chunk.doc.id;
    if(!byDoc[id] || score > byDoc[id].score) byDoc[id] = {chunk, score};
  });
  Object.values(byDoc).sort((a,b)=>b.score-a.score).forEach(({chunk,score})=>{
    if(results.length < Math.ceil(k/2)){
      results.push({chunk,score});
      seen.add(chunk.text);
    }
  });
  // Second pass: fill remaining with top overall
  scored.forEach(({chunk,score})=>{
    if(results.length >= k) return;
    if(!seen.has(chunk.text)){ results.push({chunk,score}); seen.add(chunk.text); }
  });

  return results
    .map((r,i) => `[${i+1}] ${r.chunk.doc.title} (${r.chunk.doc.category}) [score:${r.score.toFixed(1)}]\n${r.chunk.text}`)
    .join('\n\n---\n\n');
}

// ‚îÄ‚îÄ PROMPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SYS_TAX=`You are TaxMind ‚Äî Tax Intelligence Assistant for expert Indian tax & finance professionals. Expertise in both ITA 1961 and ITA 2025 (effective 1 Apr 2026).

MANDATORY RULES:
1) Always cite BOTH new Act 2025 section AND old Act 1961 equivalent side by side.
2) For ANY comparison query, ALWAYS use a markdown table with columns: Provision | ITA 1961 Section | ITA 2025 Section | Change/Comments.
3) State what changed/added/removed in every row.
4) Cite CBDT circulars with number+date when relevant.
5) Integrate case laws: "The Hon'ble [Court] in [Case] [Citation] held that [ratio]."
6) Never invent section numbers ‚Äî if unsure, say "Verify in Act".
7) End with ## References listing all sources.
8) Use tables for comparisons, structured headings for explanations ‚Äî never use plain bullet lists for comparative analysis.

OUTPUT FORMAT FOR COMPARISON QUERIES:
## [Topic]: ITA 1961 vs ITA 2025
| Provision | ITA 1961 | Section (1961) | ITA 2025 | Section (2025) | Key Change |
|-----------|----------|----------------|----------|----------------|------------|
| [row]     | [detail] | s. XX          | [detail] | s. YY          | [change]   |

KNOWLEDGE BASE CONTEXT (from uploaded documents):
{kbctx}

WEB SEARCH RESULTS (recent circulars, notifications, judgments):
{webctx}`;

const SYS_NOTICE=`You are TaxMind ‚Äî senior tax advocate drafting replies to Indian income tax notices.
Extract: ---NOTICE SUMMARY---\nNotice Type:\nAssessment Year:\nSection Cited:\nNature of Addition/Demand:\nAmount: ‚Çπ\nReply Deadline: (flag URGENT if <15 days)\nIssuing Authority:
Then generate: ---DRAFT REPLY---\n[Date]\nTo, The [Designation], [Ward], Income Tax Dept\nSub: Reply to Notice u/s [X] for AY [Y] ‚Äî [CLIENT NAME], PAN: [PAN]\n\n**I. INTRODUCTORY SUBMISSION**\n[acknowledge]\n**II. GROUNDS OF OBJECTION**\nGround 1: [ground with elaboration]\n**III. FACTUAL SUBMISSIONS**\n[facts]\n**IV. LEGAL SUBMISSIONS**\n4.1 [cite new+old Act sections]\n4.2 [case law with ratio and applicability]\n**V. PRAYER**\n(a) [relief]\n\nYours faithfully, [Name]\n---ENCLOSURES---\n---CASE LAWS CITED---
KNOWLEDGE BASE:\n{kbctx}
WEB RESULTS:\n{webctx}`;

const SYS_CR=`You are TaxMind's Section Cross-Reference engine.

ALWAYS output in this exact structure:
## Section Cross-Reference: [Topic]

### Summary Table
| Aspect | ITA 1961 | Section (1961) | ITA 2025 | Section (2025) | Change |
|--------|----------|----------------|----------|----------------|--------|
| [row]  | [detail] | s. XX | [detail] | s. YY | Retained/Renumbered/Amended/New/Removed |

### üìò Old Act Detail (ITA 1961)
Key provisions with section numbers from uploaded documents.

### üìó New Act Detail (ITA 2025)
Key provisions with section numbers from uploaded documents.

### ‚ö° Effective Date & Practical Impact

## References
IMPORTANT: Use ONLY section numbers found in uploaded documents. If uncertain write "Verify in Act".
KNOWLEDGE BASE:
{kbctx}
WEB RESULTS:
{webctx}`;

// ‚îÄ‚îÄ WEB SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


async function webSearch(query) {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    const r = await fetch('/api/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!r.ok) return { results: [], source: 'error' };
    const d = await r.json();
    if (!d.ok) return { results: [], source: 'not_configured' };
    return { results: d.results || [], source: 'web' };
  } catch(e) {
    return { results: [], source: 'error' };
  }
}

function formatWebResults(results) {
  if (!results.length) return 'No recent web results found.';
  return results.map((r, i) =>
    `[W${i+1}] ${r.title}\nURL: ${r.url}\n${r.snippet}${r.published ? '\nDate: '+r.published : ''}`
  ).join('\n\n');
}

// ‚îÄ‚îÄ WEB TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleWeb(el){ localStorage.setItem('tm_web', el.checked?'1':'0'); }
document.addEventListener('DOMContentLoaded',()=>{
  const saved = localStorage.getItem('tm_web');
  if(saved==='0'){ const t=document.getElementById('webToggle'); if(t) t.checked=false; }
});
function isWebOn(){ const t=document.getElementById('webToggle'); return t?t.checked:true; }

// ‚îÄ‚îÄ CLAUDE CALL (via secure proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function claude(sys, messages, kbctx='', webctx='', maxTokens=2000) {
  const s = sys
    .replace('{kbctx}', kbctx || 'No documents uploaded yet.')
    .replace('{webctx}', webctx || 'Web search not available.');
  const r = await fetch('/api/claude', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: MODEL, max_tokens: maxTokens, system: s, messages })
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.error || e.error?.message || 'API error'); }
  return (await r.json()).content[0].text;
}

// ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function md(t){
  if(!t)return'';
  return t.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/^---+$/gm,'<hr/>').replace(/^\| ?(.+?) ?\|$/gm,(_,r)=>'<tr>'+r.split('|').map(c=>`<td>${c.trim()}</td>`).join('')+'</tr>')
    .replace(/((<tr>.*?<\/tr>\n?)+)/gs,rows=>{const[h,...rest]=rows.trim().split('\n').filter(l=>l.includes('<tr>'));return`<table><thead>${h.replace(/<td>/g,'<th>').replace(/<\/td>/g,'</th>')}</thead><tbody>${rest.join('')}</tbody></table>`;})
    .replace(/^- (.+)$/gm,'<li>$1</li>').replace(/(<li>.*?<\/li>\n?)+/gs,'<ul>$&</ul>')
    .replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br/>').replace(/^(?!<[htupblo])(.+)$/gm,'<p>$1</p>');
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sw(t){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.sb-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('panel-'+t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('sb-'+t).classList.add('active');
}
function toggleSb(){document.getElementById('sidebar').classList.toggle('collapsed');}
function closeSetup(){document.getElementById('setupModal').style.display='none';sw('kb');}

function renderQQ(){
  document.getElementById('qqList').innerHTML=QQ.map(q=>`<button class="qq-item" onclick="qq(${JSON.stringify(q)})">${q}</button>`).join('');
  document.getElementById('chips').innerHTML=QQ.map(q=>`<button class="chip" onclick="qq(${JSON.stringify(q)})">${q}</button>`).join('');
}
function qq(q){sw('chat');document.getElementById('chatInput').value=q;sendChat();}
function renderPills(){document.getElementById('spills').innerHTML=SECS.map(s=>`<button class="sp" onclick="ql('${s}')">s. ${s}</button>`).join('');}
function ql(s){document.getElementById('crSec').value=s;sw('crossref');lookup();}
function hkey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}
function resize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';document.getElementById('sendBtn').disabled=!el.value.trim();}

async function sendChat(){
  const inp=document.getElementById('chatInput');
  const text=inp.value.trim();
  if(!text)return;
  document.getElementById('welcomeScr').style.display='none';
  msgs.push({role:'user',content:text});
  addMsg('user',text);
  inp.value='';inp.style.height='auto';document.getElementById('sendBtn').disabled=true;
  const tid=showTyping(isWebOn()?'Searching KB + web‚Ä¶':'Searching KB‚Ä¶');
  try{
    // Load chunks if not yet loaded
    await ensureChunks();
    // KB retrieval always runs; web search only if toggle is on
    const kbctx = getCtx(text);
    let webData = { results: [] };
    if(isWebOn()){
      webData = await webSearch(text + ' income tax India 2025');
    }
    const webctx = formatWebResults(webData.results);
    const sources = [];
    if(KB().length) sources.push('üìö Knowledge Base');
    if(webData.results.length) sources.push('üåê Web ('+webData.results.length+' results)');

    rmTyping(tid);
    const tid2=showTyping('Generating answer‚Ä¶');
    const reply=await claude(SYS_TAX,msgs,kbctx,webctx,2000);
    msgs.push({role:'assistant',content:reply});
    rmTyping(tid2);
    addMsg('assistant',reply,sources);
  }catch(e){rmTyping(tid);addMsg('assistant','‚ö†Ô∏è '+e.message);showToast(e.message,'error');}
}

function addMsg(role,content,srcs=[]){
  const area=document.getElementById('chatArea');
  const row=document.createElement('div');
  row.className='msg-row '+role;
  const now=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  const s=srcs.length?`<div style="margin-top:5px">${srcs.map(x=>`<span class="src-tag">${x}</span>`).join('')}</div>`:'';
  const b=role==='assistant'?`<div class="md">${md(content)}</div>`:content;
  row.innerHTML=`<div class="av ${role==='assistant'?'ai':'user'}">${role==='assistant'?'‚öñ':'üë§'}</div><div><div class="bubble ${role==='assistant'?'ai':'user'}">${b}</div>${s}<div class="b-meta">${now}</div></div>`;
  area.appendChild(row);area.scrollTop=area.scrollHeight;
}

let tc=0;
function showTyping(label=''){
  const id='t'+(++tc);
  const area=document.getElementById('chatArea');
  const r=document.createElement('div');r.className='msg-row';r.id=id;
  const lbl=label?`<span style="font-size:11px;color:var(--text-dim);margin-left:8px">${label}</span>`:'';
  r.innerHTML=`<div class="av ai">‚öñ</div><div style="display:flex;align-items:center"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>${lbl}</div>`;
  area.appendChild(r);area.scrollTop=area.scrollHeight;return id;
}
function rmTyping(id){const e=document.getElementById(id);if(e)e.remove();}

async function analyzeNotice(){
  const text=document.getElementById('noticeInput').value.trim();
  if(!text){showToast('Paste notice content first','error');return;}
  const btn=document.getElementById('analyzeBtn');btn.disabled=true;btn.textContent='Analyzing‚Ä¶';
  try{
    await ensureChunks();
    const [kbctx, webData] = await Promise.all([
      Promise.resolve(getCtx(text+' notice reply draft case law',8)),
      webSearch(text + ' income tax notice reply case law India')
    ]);
    const reply=await claude(SYS_NOTICE,[{role:'user',content:'Analyze this income tax notice and generate a complete professional draft reply:\n\n'+text}],kbctx,formatWebResults(webData.results));
    const sm=reply.match(/---NOTICE SUMMARY---([\s\S]*?)---DRAFT REPLY---/);
    if(sm){
      const lines=sm[1].trim().split('\n').filter(l=>l.includes(':'));
      const items=lines.map(l=>{const[k,...v]=l.split(':');return{k:k.trim(),v:v.join(':').trim()};}).filter(i=>i.v&&!i.v.startsWith('['));
      const urgent=sm[1].toLowerCase().includes('urgent');
      document.getElementById('noticeSumCard').innerHTML=`<h3>üìã Notice Summary ${urgent?'<span class="ubadge">‚ö† URGENT</span>':''}</h3><div class="nsg">${items.map(i=>`<div class="nsi"><div class="nsk">${i.k}</div><div class="nsv">${i.v}</div></div>`).join('')}</div>`;
    }
    document.getElementById('draftContent').innerHTML=md(reply);
    document.getElementById('noticeResult').style.display='block';
    document.getElementById('noticeResult').scrollIntoView({behavior:'smooth'});
    showToast('Draft generated!','success');
  }catch(e){showToast('Failed: '+e.message,'error');}
  btn.disabled=false;btn.textContent='‚ö° Analyze & Draft Reply';
}

function copyDraft(){navigator.clipboard.writeText(document.getElementById('draftContent').innerText).then(()=>showToast('Copied!','success'));}

async function lookup(){
  const s=document.getElementById('crSec').value.trim();
  const k=document.getElementById('crKw').value.trim();
  if(!s&&!k){showToast('Enter a section or keyword','error');return;}
  const q=s?`Compare old ITA 1961 Section ${s} with new ITA 2025 equivalent.`:`ITA 2025 provisions on "${k}" vs old ITA 1961.`;
  document.getElementById('crContent').innerHTML='<p style="color:var(--text-mid)">Searching KB and web‚Ä¶</p>';
  document.getElementById('crResult').style.display='block';
  try{
    await ensureChunks();
    const [kbctx, webData] = await Promise.all([
      Promise.resolve(getCtx(q)),
      webSearch(q + ' India income tax')
    ]);
    document.getElementById('crContent').innerHTML=md(await claude(SYS_CR,[{role:'user',content:q}],kbctx,formatWebResults(webData.results)));
  }catch(e){document.getElementById('crContent').innerHTML=`<p style="color:var(--red)">Error: ${e.message}</p>`;}
}

function showToast(msg,type='success'){
  const c={success:'var(--teal)',error:'var(--red)',info:'var(--gold)'};
  const t=document.createElement('div');t.className='toast';t.style.borderLeftColor=c[type];t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}
</script>
</body>
</html>

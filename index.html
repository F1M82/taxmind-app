<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TaxMind ‚Äî Tax Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0A0A0A;--ink-2:#1A1A1A;--ink-3:#2C2C2C;
  --paper:#FFFFFF;--paper-2:#F7F7F5;--paper-3:#EFEFEC;
  --rule:#E4E4E0;--rule-mid:#D0D0CA;
  --accent-green:#166534;--accent-green-bg:#F0FDF4;
  --accent-amber:#92400E;--accent-amber-bg:#FFFBEB;
  --accent-red:#991B1B;--accent-red-bg:#FEF2F2;
  --text:#0A0A0A;--text-2:#525252;--text-3:#A3A3A3;
  --shadow-sm:0 1px 3px rgba(0,0,0,.06);
  --shadow:0 2px 8px rgba(0,0,0,.07),0 0 0 1px rgba(0,0,0,.04);
  --shadow-lg:0 8px 32px rgba(0,0,0,.10),0 0 0 1px rgba(0,0,0,.04);
  --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'Geist',system-ui,sans-serif;background:var(--paper-2);color:var(--text);-webkit-font-smoothing:antialiased;letter-spacing:-.01em}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--rule-mid);border-radius:2px}
.shell{display:flex;height:100vh;overflow:hidden}
.sidebar{width:232px;flex-shrink:0;background:var(--paper);border-right:1px solid var(--rule);display:flex;flex-direction:column;transition:width .25s cubic-bezier(.4,0,.2,1);overflow:hidden}
.sidebar.collapsed{width:0;border-right:none}
.brand{padding:18px 16px 14px;border-bottom:1px solid var(--rule);flex-shrink:0}
.brand-mark{width:26px;height:26px;background:var(--ink);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:12px;margin-bottom:10px}
.brand-name{font-family:'Instrument Serif',serif;font-size:17px;font-weight:400;color:var(--ink);line-height:1}
.brand-sub{font-size:9.5px;color:var(--text-3);letter-spacing:.05em;text-transform:uppercase;margin-top:3px}
.sidebar-scroll{flex:1;overflow-y:auto;overflow-x:hidden;padding:6px 0}
.sb-sect{padding:14px 14px 4px}
.sb-lbl{font-size:9.5px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--text-3);margin-bottom:4px}
.sb-btn{display:flex;align-items:center;gap:9px;width:100%;padding:6px 10px;border-radius:var(--r);font-family:'Geist',sans-serif;font-size:12.5px;font-weight:400;color:var(--text-2);background:transparent;border:none;cursor:pointer;text-align:left;margin-bottom:1px;transition:all .12s;white-space:nowrap}
.sb-btn:hover{background:var(--paper-3);color:var(--ink)}
.sb-btn.active{background:var(--ink);color:var(--paper)}
.sb-btn .ic{width:16px;text-align:center;font-size:12px;flex-shrink:0;opacity:.65}
.sb-btn.active .ic{opacity:1}
.sb-btn .tag{margin-left:auto;font-size:9px;font-weight:600;background:var(--ink);color:var(--paper);padding:1px 5px;border-radius:3px;flex-shrink:0;letter-spacing:.03em}
.sb-btn.active .tag{background:rgba(255,255,255,.2)}
.kb-pill{margin:4px 10px;padding:8px 10px;border-radius:var(--r);font-size:11px;cursor:default;border:1px solid var(--rule)}
.kb-pill.ok{background:var(--accent-green-bg);border-color:#BBF7D0}
.kb-pill.warn{background:var(--accent-amber-bg);border-color:#FDE68A}
.kb-pill .kp-dot{width:5px;height:5px;border-radius:50%;display:inline-block;margin-right:5px;vertical-align:middle}
.kb-pill.ok .kp-dot{background:#16A34A;animation:blink 2.5s infinite}
.kb-pill.warn .kp-dot{background:#D97706}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.kb-pill .kp-t{font-weight:500}
.kb-pill.ok .kp-t{color:var(--accent-green)}
.kb-pill.warn .kp-t{color:var(--accent-amber)}
.kb-pill .kp-s{font-size:10px;color:var(--text-3);margin-top:1px}
.qq-list{padding:2px 10px 10px}
.qq-item{display:block;width:100%;padding:5px 10px;background:none;border:none;text-align:left;font-family:'Geist',sans-serif;font-size:11px;color:var(--text-3);cursor:pointer;border-radius:var(--r);line-height:1.5;transition:all .12s;margin-bottom:1px}
.qq-item:hover{background:var(--paper-3);color:var(--ink)}
.sidebar-footer{padding:10px 14px;border-top:1px solid var(--rule);flex-shrink:0}
.sidebar-footer p{font-size:9.5px;color:var(--text-3);line-height:1.7;font-family:'Geist Mono',monospace}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:44px;background:var(--paper);border-bottom:1px solid var(--rule);display:flex;align-items:center;padding:0 14px;gap:6px;flex-shrink:0}
.tog{width:26px;height:26px;border-radius:var(--r);background:transparent;border:1px solid var(--rule);cursor:pointer;font-size:11px;color:var(--text-2);display:flex;align-items:center;justify-content:center;transition:all .12s}
.tog:hover{background:var(--paper-3)}
.tab-row{display:flex;gap:1px;margin-left:4px}
.tab{padding:4px 11px;border-radius:var(--r);font-size:12px;font-weight:400;border:none;background:transparent;cursor:pointer;color:var(--text-2);transition:all .12s;font-family:'Geist',sans-serif}
.tab:hover{background:var(--paper-3);color:var(--ink)}
.tab.active{background:var(--ink);color:var(--paper)}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:6px}
.status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.status-dot.green{background:#16A34A;box-shadow:0 0 0 2px #DCFCE7}
.status-dot.red{background:#DC2626;animation:pulse-r 2s infinite}
.status-dot.amber{background:#D97706}
@keyframes pulse-r{0%,100%{opacity:1}50%{opacity:.35}}
.tb-label{font-size:11px;color:var(--text-3);font-family:'Geist Mono',monospace}
.panel{flex:1;overflow:hidden;display:none;flex-direction:column}
.panel.active{display:flex}
.chat-area{flex:1;overflow-y:auto;padding:20px 0 12px}
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:48px 32px;text-align:center}
.welcome-seal{width:48px;height:48px;background:var(--ink);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:20px}
.welcome h1{font-family:'Instrument Serif',serif;font-size:30px;font-weight:400;color:var(--ink);margin-bottom:8px;letter-spacing:-.02em}
.welcome p{font-size:13px;color:var(--text-2);max-width:360px;line-height:1.75;margin-bottom:8px;font-weight:300}
.welcome .kb-notice{font-size:11px;color:var(--text-2);margin-bottom:28px;padding:6px 14px;background:var(--paper-3);border:1px solid var(--rule);border-radius:var(--r);display:inline-block;font-family:'Geist Mono',monospace}
.chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:500px}
.chip{padding:5px 13px;background:var(--paper);border:1px solid var(--rule);border-radius:100px;font-size:11.5px;color:var(--text-2);cursor:pointer;transition:all .15s;font-family:'Geist',sans-serif;box-shadow:var(--shadow-sm)}
.chip:hover{border-color:var(--ink);color:var(--ink)}
.msg-row{display:flex;padding:4px 20px;gap:10px;animation:msgIn .16s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user{flex-direction:row-reverse}
.av{width:24px;height:24px;border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;margin-top:3px}
.av.ai{background:var(--ink);color:var(--paper)}
.av.user{background:var(--paper-3);border:1px solid var(--rule);font-size:10px}
.bubble{max-width:92%;padding:11px 15px;border-radius:8px;font-size:13px;line-height:1.75}
.bubble.ai{background:var(--paper);border:1px solid var(--rule);color:var(--text);border-top-left-radius:2px;box-shadow:var(--shadow-sm);width:100%}
.bubble.user{background:var(--ink);color:rgba(255,255,255,.88);border-top-right-radius:2px}
.b-meta{font-size:9px;color:var(--text-3);margin-top:4px;font-family:'Geist Mono',monospace}
.msg-row.user .b-meta{text-align:right}
.src-tag{font-size:10px;padding:2px 6px;background:var(--paper-3);border:1px solid var(--rule);border-radius:3px;color:var(--text-2);font-family:'Geist Mono',monospace;margin:3px 3px 0 0;display:inline-block}
.md h1{font-family:'Instrument Serif',serif;font-size:1.15rem;font-weight:400;color:var(--ink);margin:14px 0 5px;letter-spacing:-.02em}
.md h2{font-family:'Instrument Serif',serif;font-size:1.05rem;font-weight:400;color:var(--ink-2);margin:12px 0 4px;padding-bottom:4px;border-bottom:1px solid var(--rule)}
.md h3{font-size:.8rem;font-weight:600;color:var(--ink-3);margin:9px 0 3px;text-transform:uppercase;letter-spacing:.05em}
.md p{margin:4px 0}.md ul,.md ol{padding-left:1.2rem;margin:3px 0}.md li{margin:2px 0}
.md strong{font-weight:600;color:var(--ink)}.md em{color:var(--text-2);font-style:italic}
.md code{font-family:'Geist Mono',monospace;font-size:.78rem;background:var(--paper-3);padding:1px 5px;border-radius:3px;color:var(--ink-2)}
.md table{width:100%;border-collapse:collapse;margin:8px 0;font-size:.82rem}
.md th{background:var(--paper-3);color:var(--ink);padding:7px 11px;text-align:left;font-weight:600;font-size:.76rem;text-transform:uppercase;letter-spacing:.04em;border-bottom:2px solid var(--rule-mid)}
.md td{padding:6px 11px;border-bottom:1px solid var(--rule);border-right:1px solid var(--rule)}
.md td:first-child{border-left:1px solid var(--rule)}
.md tr:nth-child(even) td{background:var(--paper-2)}
.md blockquote{border-left:2px solid var(--ink-3);padding-left:12px;color:var(--text-2);margin:6px 0;font-style:italic}
.md hr{border:none;border-top:1px solid var(--rule);margin:8px 0}
.md h4{font-size:.78rem;font-weight:700;color:var(--ink);margin:10px 0 4px;text-transform:uppercase;letter-spacing:.06em;background:var(--paper-3);padding:4px 8px;border-radius:3px;border-left:3px solid var(--rule-mid)}
.calc-table{width:100%;border-collapse:collapse;margin:12px 0;font-size:.82rem;font-family:'Geist Mono',monospace;border:1px solid var(--rule);table-layout:fixed}
.calc-table colgroup .col-label{width:68%}
.calc-table colgroup .col-amt{width:32%}
.calc-table td{padding:6px 12px;border:none;border-bottom:1px solid var(--rule);overflow:hidden;word-wrap:break-word}
.calc-table td:first-child{width:68%}
.calc-table td:last-child{width:32%;text-align:right;font-variant-numeric:tabular-nums}
.calc-table td.calc-amt{text-align:right;font-variant-numeric:tabular-nums;font-weight:500}
.calc-table tr:nth-child(even) td{background:var(--paper-2)}
.calc-table tr.calc-head td{background:var(--paper-3)!important;color:var(--ink);font-family:'Geist',sans-serif;font-size:.73rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:7px 12px;border-bottom:2px solid var(--rule-mid);width:auto}
.calc-table tr.calc-head td:last-child{text-align:right;color:var(--ink-2);font-weight:500}
.calc-table tr.calc-label td{color:var(--ink-2);padding-left:20px;font-style:italic;background:transparent!important}
.calc-table tr.calc-sub td:first-child{padding-left:20px;color:var(--ink-2)}
.calc-table tr.calc-sep td{border-top:1px solid var(--rule-mid);padding:0;background:transparent!important;border-bottom:none;height:1px}
.calc-table tr.calc-total td{font-weight:700;color:var(--ink);border-top:2px solid var(--rule-mid);border-bottom:2px solid var(--rule-mid);background:var(--paper-3)!important}
.calc-amt{text-align:right}
.code-block{background:var(--paper-3);border:1px solid var(--rule);border-radius:var(--r);padding:10px 14px;margin:8px 0;overflow-x:auto}
.code-block pre{font-family:'Geist Mono',monospace;font-size:.78rem;margin:0;white-space:pre;color:var(--ink)}ar(--ink)}
.typing{display:flex;gap:4px;padding:11px 15px;background:var(--paper);border:1px solid var(--rule);border-radius:8px;border-top-left-radius:2px;box-shadow:var(--shadow-sm);align-items:center}
.dot{width:5px;height:5px;background:var(--ink-3);border-radius:50%;animation:dots 1.2s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes dots{0%,80%,100%{transform:scale(.5);opacity:.3}40%{transform:scale(1);opacity:.8}}
.input-bar{padding:10px 20px 14px;background:var(--paper);border-top:1px solid var(--rule);flex-shrink:0}
.input-wrap{display:flex;gap:8px;align-items:flex-end;background:var(--paper);border:1px solid var(--rule);border-radius:8px;padding:8px 8px 8px 14px;transition:border-color .15s,box-shadow .15s;box-shadow:var(--shadow-sm)}
.input-wrap:focus-within{border-color:var(--ink);box-shadow:0 0 0 3px rgba(0,0,0,.05)}
.input-ta{flex:1;background:transparent;border:none;outline:none;resize:none;font-family:'Geist',sans-serif;font-size:13px;color:var(--text);line-height:1.5;max-height:110px;overflow-y:auto;letter-spacing:-.01em}
.input-ta::placeholder{color:var(--text-3)}
.send-btn{width:30px;height:30px;border-radius:5px;flex-shrink:0;background:var(--ink);border:none;cursor:pointer;font-size:12px;color:var(--paper);display:flex;align-items:center;justify-content:center;font-weight:600;transition:all .12s}
.send-btn:hover{background:var(--ink-3)}.send-btn:disabled{opacity:.22;cursor:not-allowed}
.input-hint{font-size:10px;color:var(--text-3);text-align:center;margin-top:5px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px}
.cpanel{flex:1;overflow-y:auto;padding:24px 28px}
.ptitle{font-family:'Instrument Serif',serif;font-size:22px;font-weight:400;color:var(--ink);margin-bottom:4px;letter-spacing:-.02em}
.psub{font-size:12px;color:var(--text-2);line-height:1.7;margin-bottom:20px;font-weight:300}
.icards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
.icard{background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:12px 14px;box-shadow:var(--shadow-sm)}
.icard .ci{font-size:14px;margin-bottom:5px}
.icard .cl{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px;font-weight:500}
.icard .cv{font-size:11.5px;color:var(--text-2);line-height:1.5}
.bta{width:100%;min-height:200px;background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:14px;font-family:'Geist',sans-serif;font-size:12.5px;color:var(--text);resize:vertical;outline:none;line-height:1.7;transition:border-color .15s;box-shadow:var(--shadow-sm)}
.bta:focus{border-color:var(--ink);box-shadow:0 0 0 3px rgba(0,0,0,.04)}.bta::placeholder{color:var(--text-3)}
.arow{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
.pbtn{padding:8px 18px;border-radius:var(--r);border:none;cursor:pointer;font-family:'Geist',sans-serif;font-size:12.5px;font-weight:500;background:var(--ink);color:var(--paper);transition:all .12s}
.pbtn:hover{background:var(--ink-3)}.pbtn:disabled{opacity:.35;cursor:not-allowed}
.gbtn{padding:8px 14px;border-radius:var(--r);border:1px solid var(--rule);background:transparent;color:var(--text-2);font-size:12px;cursor:pointer;font-family:'Geist',sans-serif;transition:all .12s}
.gbtn:hover{background:var(--paper-3)}
.warn-note{font-size:10.5px;color:var(--text-3);margin-top:8px}
.notice-sum{background:var(--accent-amber-bg);border:1px solid #FDE68A;border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
.notice-sum h3{font-size:9.5px;font-weight:600;color:var(--accent-amber);text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px}
.nsg{display:grid;grid-template-columns:1fr 1fr;gap:5px 16px}
.nsi .nsk{font-size:9.5px;color:var(--text-3);margin-bottom:1px;text-transform:uppercase;letter-spacing:.05em}
.nsi .nsv{font-size:12px;font-weight:500;color:var(--ink)}
.ubadge{display:inline-block;padding:2px 7px;background:var(--accent-red-bg);border:1px solid #FECACA;border-radius:3px;font-size:9.5px;font-weight:600;color:var(--accent-red);margin-left:5px;text-transform:uppercase;letter-spacing:.04em}
.kstats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px}
.scard{background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:14px;box-shadow:var(--shadow-sm)}
.scard .sn{font-size:24px;font-family:'Instrument Serif',serif;font-weight:400;color:var(--ink);line-height:1}
.scard .sl{font-size:9.5px;color:var(--text-3);text-transform:uppercase;letter-spacing:.07em;margin-top:4px;font-weight:500}
.sync-bar{background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow-sm)}
.sync-bar .sb-info{flex:1}
.sync-bar .sb-title{font-size:12.5px;font-weight:500;color:var(--ink);margin-bottom:2px}
.sync-bar .sb-sub{font-size:11px;color:var(--text-3);font-family:'Geist Mono',monospace}
.sync-btn{padding:7px 16px;border-radius:var(--r);border:1px solid var(--rule);cursor:pointer;font-family:'Geist',sans-serif;font-size:12px;font-weight:400;background:var(--paper);color:var(--ink);transition:all .12s;flex-shrink:0}
.sync-btn:hover{background:var(--paper-3)}.sync-btn:disabled{opacity:.35;cursor:not-allowed}
.upload-form{background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:18px;margin-bottom:18px;box-shadow:var(--shadow-sm)}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fg label{display:block;font-size:9.5px;font-weight:500;color:var(--text-3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.fi,.fs{width:100%;padding:7px 10px;background:var(--paper-2);border:1px solid var(--rule);border-radius:var(--r);font-family:'Geist',sans-serif;font-size:12.5px;color:var(--text);outline:none;transition:border-color .12s}
.fi:focus,.fs:focus{border-color:var(--ink);background:var(--paper);box-shadow:0 0 0 3px rgba(0,0,0,.04)}
.ubox{background:var(--paper-2);border:1.5px dashed var(--rule-mid);border-radius:var(--r);padding:24px;text-align:center;cursor:pointer;transition:all .15s;margin-top:12px}
.ubox:hover,.ubox.drag{border-color:var(--ink);background:var(--paper-3)}
.ubox .ui{font-size:20px;margin-bottom:7px}
.ubox .ut{font-size:12.5px;font-weight:500;color:var(--ink);margin-bottom:3px}
.ubox .us{font-size:11px;color:var(--text-3)}
.pbar{height:2px;background:var(--paper-3);border-radius:2px;overflow:hidden;margin-top:8px}
.pfill{height:100%;background:var(--ink);border-radius:2px;transition:width .3s}
.doc-list{display:flex;flex-direction:column;gap:6px}
.drow{background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:10px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow-sm)}
.drow:hover{border-color:var(--rule-mid)}
.drow .di{font-size:14px;flex-shrink:0}
.drow .dinfo{flex:1;min-width:0}
.drow .dt{font-size:12.5px;font-weight:500;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.drow .dm{font-size:10px;color:var(--text-3);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap;font-family:'Geist Mono',monospace}
.drow .dc{font-size:10px;padding:2px 6px;background:var(--paper-3);color:var(--text-2);border-radius:3px;font-weight:500;flex-shrink:0;border:1px solid var(--rule)}
.drow .ddel{background:none;border:1px solid var(--rule);border-radius:var(--r);padding:3px 8px;color:var(--text-3);font-size:10px;cursor:pointer;transition:all .12s;flex-shrink:0;font-family:'Geist',sans-serif}
.drow .ddel:hover{border-color:#FECACA;color:var(--accent-red)}
.src-badge{font-size:9px;padding:2px 5px;border-radius:3px;font-weight:500;flex-shrink:0;text-transform:uppercase;letter-spacing:.04em}
.src-badge.shared{background:var(--accent-green-bg);color:var(--accent-green);border:1px solid #BBF7D0}
.src-badge.local{background:var(--accent-amber-bg);color:var(--accent-amber);border:1px solid #FDE68A}
.cr-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.spills{display:flex;flex-wrap:wrap;gap:4px;margin-top:12px}
.sp{padding:3px 10px;background:var(--paper);border:1px solid var(--rule);border-radius:3px;font-family:'Geist Mono',monospace;font-size:11px;color:var(--text-2);cursor:pointer;transition:all .12s;box-shadow:var(--shadow-sm)}
.sp:hover{border-color:var(--ink);color:var(--ink)}
.empty-st{text-align:center;padding:40px 20px;color:var(--text-3);font-size:12px}
.empty-st .esi{font-size:26px;margin-bottom:10px}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000}
.mb{background:var(--paper);border:1px solid var(--rule);border-radius:10px;padding:28px;width:420px;max-width:92vw;box-shadow:var(--shadow-lg);animation:mIn .2s ease}
@keyframes mIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.mb-ico{font-size:26px;text-align:center;margin-bottom:12px}
.mb h2{font-family:'Instrument Serif',serif;font-size:22px;font-weight:400;color:var(--ink);text-align:center;margin-bottom:5px}
.mb p{font-size:12.5px;color:var(--text-2);line-height:1.7;text-align:center;margin-bottom:18px;font-weight:300}
.mi{width:100%;padding:9px 12px;background:var(--paper-2);border:1px solid var(--rule);border-radius:var(--r);font-family:'Geist Mono',monospace;font-size:12.5px;color:var(--text);outline:none;margin-bottom:9px}
.mi:focus{border-color:var(--ink);background:var(--paper);box-shadow:0 0 0 3px rgba(0,0,0,.04)}
.mb-btn{width:100%;padding:10px;border-radius:var(--r);border:none;cursor:pointer;font-family:'Geist',sans-serif;font-size:13px;font-weight:500;background:var(--ink);color:var(--paper);margin-bottom:7px;transition:all .12s}
.mb-btn:hover{background:var(--ink-3)}
.mb-note{font-size:10.5px;color:var(--text-3);text-align:center;line-height:1.6}
.msg-actions{display:flex;gap:4px;margin-top:6px;opacity:0;transition:opacity .15s}
.msg-row:hover .msg-actions{opacity:1}
.act-btn{padding:3px 9px;border:1px solid var(--rule);border-radius:4px;background:var(--paper);color:var(--text-3);font-size:10.5px;cursor:pointer;font-family:'Geist',sans-serif;display:flex;align-items:center;gap:4px;transition:all .12s}
.act-btn:hover{background:var(--paper-3);color:var(--ink);border-color:var(--rule-mid)}
.act-btn svg{width:11px;height:11px;flex-shrink:0}
.toast{position:fixed;bottom:20px;right:20px;background:var(--paper);border:1px solid var(--rule);border-radius:var(--r);padding:10px 14px;font-size:12px;color:var(--text);z-index:2000;box-shadow:var(--shadow-lg);animation:tIn .2s ease;max-width:280px;border-left:3px solid var(--ink);font-family:'Geist',sans-serif}
@keyframes tIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- SETUP MODAL (shown when KB is empty on first visit) -->
<div class="mo" id="setupModal" style="display:none">
  <div class="mb">
    <div class="mb-ico">‚öñÔ∏è</div>
    <h2>TaxMind ‚Äî First Setup</h2>
    <p>The knowledge base is empty. Go to the <strong>Knowledge Base</strong> tab to upload your Income Tax Act 2025 PDF. Once indexed, all team members will have access automatically.</p>
    <button class="mb-btn" onclick="closeSetup()">Open Knowledge Base ‚Üí</button>
    <p class="mb-note">This message only appears when the shared KB has no documents.</p>
  </div>
</div>

<div class="shell">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-mark">‚öñÔ∏è</div>
      <div class="brand-name">TaxMind</div>
      <div class="brand-sub">Tax Intelligence ¬∑ Team</div>
    </div>
    <div class="sidebar-scroll">
      <div class="sb-sect">
        <button class="sb-btn active" onclick="sw('chat')" id="sb-chat"><span class="ic">üí¨</span>Tax Query</button>
        <button class="sb-btn" onclick="sw('notice')" id="sb-notice"><span class="ic">üìã</span>Notice Analyzer</button>
        <button class="sb-btn" onclick="sw('crossref')" id="sb-crossref"><span class="ic">üîÄ</span>Section Cross-Ref</button>
        <button class="sb-btn" onclick="sw('kb')" id="sb-kb"><span class="ic">üìö</span>Knowledge Base</button>
      </div>


    </div>
    <div class="sidebar-footer"><p>ITA 2025 ¬∑ Effective 1 Apr 2026<br>Powered by Claude Sonnet 4</p></div>
  </div>

  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <button class="tog" onclick="toggleSb()">‚ò∞</button>
      <div class="tab-row">
        <button class="tab active" onclick="sw('chat')" id="tab-chat">Chat</button>
        <button class="tab" onclick="sw('notice')" id="tab-notice">Notice Draft</button>
        <button class="tab" onclick="sw('crossref')" id="tab-crossref">Cross-Ref</button>
        <button class="tab" onclick="sw('kb')" id="tab-kb">Knowledge Base</button>
      </div>

    </div>

    <!-- CHAT -->
    <div class="panel active" id="panel-chat">
      <div class="chat-area" id="chatArea">
        <div class="welcome" id="welcomeScr">
          <div class="welcome-seal">‚öñÔ∏è</div>
          <h1>TaxMind is Ready</h1>
          <p>Your firm's AI assistant for the new Income Tax Act 2025. Every answer cites both the new and old Act sections.</p>

        </div>
      </div>
      <div class="input-bar">
        <div class="input-wrap">
          <textarea class="input-ta" id="chatInput" rows="1" placeholder="Ask anything about Income Tax Act 2025‚Ä¶" onkeydown="hkey(event)" oninput="resize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendChat()" disabled>‚Üë</button>
        </div>
        <div class="input-hint" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">
          <span>Enter to send ¬∑ Shift+Enter new line</span>
          <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:11px;color:var(--text-dim)">
            <input type="checkbox" id="webToggle" checked onchange="toggleWeb(this)" style="accent-color:var(--teal)"/>
            üåê Web search
          </label>
        </div>
      </div>
    </div>

    <!-- NOTICE -->
    <div class="panel" id="panel-notice">
      <div class="cpanel">
        <div class="ptitle">üìã Notice Analyzer & Draft Reply</div>
        <div class="psub">Paste any income tax notice. TaxMind extracts details and generates a complete draft reply with legal submissions and case law citations.</div>
        <div class="icards">
          <div class="icard"><div class="ci">üìÑ</div><div class="cl">Notice Types</div><div class="cv">143(1), 148, 148A, 154, 156, 263, 271 & all standard types</div></div>
          <div class="icard"><div class="ci">‚ö°</div><div class="cl">Output</div><div class="cv">Complete draft ‚Äî grounds, legal submissions, case laws, prayer</div></div>
          <div class="icard"><div class="ci">üîí</div><div class="cl">Confidentiality</div><div class="cv">Replace client name & PAN with [CLIENT NAME] and [PAN]</div></div>
        </div>
        <textarea class="bta" id="noticeInput" placeholder="Paste notice content here...&#10;&#10;Example:&#10;F.No. ITO/Ward-3/2025-26/1234 | Date: 15-01-2026&#10;To: [CLIENT NAME], PAN: [PAN]&#10;Sub: Notice u/s 148A(b) for AY 2022-23&#10;You are hereby required to show cause..."></textarea>
        <div class="arow">
          <button class="pbtn" id="analyzeBtn" onclick="analyzeNotice()">‚ö° Analyze & Draft Reply</button>
          <button class="gbtn" onclick="document.getElementById('noticeInput').value=''">Clear</button>
        </div>
        <div class="warn-note">‚ö† Replace actual client name and PAN before pasting.</div>
        <div id="noticeResult" style="margin-top:20px;display:none">
          <div class="notice-sum" id="noticeSumCard"></div>
          <div style="background:white;border:1px solid var(--border);border-radius:9px;padding:18px;box-shadow:var(--shadow)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <div style="font-weight:600;font-size:13.5px;color:var(--ink)">üìù Draft Reply</div>
              <button class="gbtn" onclick="copyDraft()" style="font-size:11.5px;padding:5px 12px">Copy</button>
            </div>
            <div id="draftContent" class="md" style="font-size:12.5px;line-height:1.82;color:var(--text)"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CROSSREF -->
    <div class="panel" id="panel-crossref">
      <div class="cpanel">
        <div class="ptitle">üîÄ Section Cross-Reference</div>
        <div class="psub">Enter an old Act section number or topic keyword for a side-by-side comparison with the new ITA 2025.</div>
        <div class="cr-grid">
          <div class="fg"><label>Old Act Section (ITA 1961)</label><input class="fi" id="crSec" placeholder="e.g. 80C, 148, 10(38)" onkeydown="if(event.key==='Enter')lookup()" style="font-family:'JetBrains Mono',monospace;font-size:14px"/></div>
          <div class="fg"><label>Or Search by Topic</label><input class="fi" id="crKw" placeholder="e.g. capital gains, TDS, deduction" onkeydown="if(event.key==='Enter')lookup()"/></div>
        </div>
        <button class="pbtn" onclick="lookup()">Look Up ‚Üí</button>
        <div style="margin-top:20px"><div style="font-size:10px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px">Common Sections</div><div class="spills" id="spills"></div></div>
        <div id="crResult" style="margin-top:20px;display:none">
          <div style="background:white;border:1px solid var(--border);border-radius:9px;padding:18px;box-shadow:var(--shadow)">
            <div id="crContent" class="md" style="font-size:12.5px;line-height:1.8"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- KB -->
    <div class="panel" id="panel-kb">
      <div class="cpanel">
        <div class="ptitle">üìö Knowledge Base</div>
        <div class="psub">Upload documents below ‚Äî they're shared with your entire team instantly. Stored centrally; no one needs to upload individually.</div>
        <div class="kstats">
          <div class="scard"><div class="sn" id="stDocs">‚Äî</div><div class="sl">Shared Docs</div></div>
          <div class="scard"><div class="sn" id="stChunks">‚Äî</div><div class="sl">Text Chunks</div></div>
          <div class="scard"><div class="sn" id="stLocal">0</div><div class="sl">Local Only</div></div>
          <div class="scard"><div class="sn" id="stSize">‚Äî</div><div class="sl">Storage</div></div>
        </div>

        <!-- Sync bar -->
        <div class="sync-bar">
          <div class="sb-info">
            <div class="sb-title">üîÑ Shared Knowledge Base</div>
            <div class="sb-sub" id="lastSync">Click Sync to load the latest documents from the server</div>
          </div>
          <button class="sync-btn" id="syncBtn" onclick="syncKB()">Sync Now</button>
        </div>

        <!-- Upload form -->
        <div class="upload-form">
          <div style="font-size:13.5px;font-weight:600;color:var(--ink);margin-bottom:13px">üì§ Add Document (shared with team)</div>
          <div class="fgrid">
            <div class="fg"><label>Title *</label><input class="fi" id="docTitle" placeholder="e.g. Income Tax Act 2025"/></div>
            <div class="fg"><label>Category *</label>
              <select class="fs" id="docCat" onchange="toggleCL()">
                <option>New Act</option><option>Old Act</option><option>Rules</option>
                <option>CBDT Circular</option><option>Notification</option><option>Finance Act</option>
                <option>Case Law</option><option>ITAT Order</option><option>Section Mapping</option><option>Internal Notes</option>
              </select>
            </div>
            <div class="fg"><label>Sections</label><input class="fi" id="docSec" placeholder="e.g. 80C, 148"/></div>
            <div class="fg"><label>Tags</label><input class="fi" id="docTags" placeholder="e.g. deduction, capital gains"/></div>
            <div class="fg" id="clCite" style="display:none"><label>Citation</label><input class="fi" id="docCite" placeholder="(2024) 465 ITR 210 (Del)"/></div>
            <div class="fg" id="clCourt" style="display:none"><label>Court</label><input class="fi" id="docCourt" placeholder="Delhi HC / ITAT Mumbai"/></div>
            <div class="fg" id="clOut" style="display:none"><label>Outcome</label>
              <select class="fs" id="docOut">
                <option value="">Select...</option>
                <option value="taxpayer_favorable">Taxpayer Favorable ‚úì</option>
                <option value="revenue_favorable">Revenue Favorable</option>
                <option value="mixed">Mixed</option>
              </select>
            </div>
          </div>
          <input type="file" id="fileIn" accept=".pdf,.txt,.md" style="display:none" onchange="fileSel(this)"/>
          <div class="ubox" id="ubox" onclick="document.getElementById('fileIn').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="fileDrop(event)">
            <div class="ui">üìÑ</div>
            <div class="ut">Click to select or drag & drop</div>
            <div class="us" id="uboxSub">PDF or TXT ¬∑ Max 25MB</div>
          </div>
          <div id="upProg" style="display:none;margin-top:9px">
            <div style="font-size:11.5px;color:var(--text-mid);margin-bottom:4px" id="progLbl">Processing...</div>
            <div class="pbar"><div class="pfill" id="pFill" style="width:0%"></div></div>
          </div>
          <button class="pbtn" style="margin-top:12px;width:100%" id="idxBtn" onclick="indexDoc()">üì§ Index & Share with Team</button>
        </div>

        <div style="font-size:10.5px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:9px" id="dlLabel">Documents (0)</div>
        <div class="doc-list" id="docList"><div class="empty-st"><div class="esi">üì≠</div>No documents yet. Upload your ITA 2025 PDF above.</div></div>
      </div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let msgs=[];
let sharedKB=[];   // from server
let localKB=[];    // local uploads not yet indexed
let selFile=null;

try{localKB=JSON.parse(localStorage.getItem('tm_local_kb')||'[]');}catch(e){localKB=[];}

const KB=()=>[...sharedKB,...localKB];
const MODEL='claude-sonnet-4-20250514';
const QQ=['What replaces Section 80C in the new Act?','Compare Section 148 reassessment old vs new','New TDS rates under ITA 2025','Capital gains changes in new Act','Section 68 unexplained cash credit ‚Äî what changed?','New presumptive taxation ‚Äî 44AD equivalent'];
const SECS=['80C','80D','10(38)','148','148A','147','263','68','69A','54','54F','24(b)','44AD','44ADA','115BAC','271AAB'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  renderQQ(); renderPills();
  // Show app immediately, load KB in background
  updateKBUI(); // render UI with empty KB first
  setTimeout(async()=>{
    await syncKB(true);
    loadChunksBackground();
  }, 100);
});

// ‚îÄ‚îÄ SHARED KB SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncKB(silent=false){
  if(!silent){
    document.getElementById('syncBtn').disabled=true;
    document.getElementById('syncBtn').textContent='Syncing‚Ä¶';
  }
  try{
    // Load metadata only ‚Äî instant
    const res=await fetch('/api/kb');
    if(!res.ok) throw new Error('Server error '+res.status);
    const data=await res.json();
    if(data.documents){
      sharedKB=data.documents.map(d=>({...d,chunks:[]}));
      _index=null; _indexedKBLen=0; chunksLoaded=false;
      updateKBUI();
      const notice=document.getElementById('kbNotice');

      if(!silent) showToast(`Synced ‚Äî ${sharedKB.length} docs ready`,'success');
      if(!silent) loadChunksBackground();
    }
  }catch(e){
    if(!silent) showToast('Sync failed: '+e.message,'error');
    updateKBUI();
  }
  if(!silent){
    document.getElementById('syncBtn').disabled=false;
    document.getElementById('syncBtn').textContent='Sync Now';
  }
}

// ‚îÄ‚îÄ CHUNK CACHE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chunksLoaded=false;
let chunksLoading=false;
const CACHE_KEY='tm_chunks_cache';
const CACHE_VER_KEY='tm_chunks_ver';

async function getCacheVersion(){
  // Version = sorted doc IDs + chunkCounts joined
  return sharedKB.map(d=>d.id+':'+d.chunkCount).sort().join('|');
}

async function loadChunksBackground(){
  if(chunksLoaded||chunksLoading) return;
  chunksLoading=true;
  try{

    const res=await fetch('/api/kb?chunks=1');
    if(!res.ok) throw new Error('chunks load failed '+res.status);
    const data=await res.json();
    if(data.documents && data.documents.length){
      // Merge chunks into existing sharedKB entries by id
      data.documents.forEach(serverDoc => {
        const idx = sharedKB.findIndex(d => d.id === serverDoc.id);
        if(idx >= 0){
          sharedKB[idx] = serverDoc; // replace with full doc including chunks
        } else {
          sharedKB.push(serverDoc);
        }
      });
      _index=null; _indexedKBLen=0;
      chunksLoaded=true;
      const totalChunks = sharedKB.reduce((s,d)=>s+(d.chunks||[]).length,0);

      const notice=document.getElementById('kbNotice');
      if(notice) notice.textContent=`‚úÖ ${sharedKB.length} documents ¬∑ ${totalChunks.toLocaleString()} chunks indexed and ready`;
    }
  }catch(e){
    console.warn('chunk load error',e);

  }
  chunksLoading=false;
}

async function ensureChunks(){
  if(chunksLoaded) return;
  if(!chunksLoading) loadChunksBackground();
  // Wait for chunks to load (max 30s)
  let tries=0;
  while(!chunksLoaded && tries<60){
    await new Promise(r=>setTimeout(r,500));
    tries++;
  }
}

async function pushToServer(docs){
  try{
    const PAGE = 50;
    for(const doc of docs){
      const allChunks = doc.chunks || [];
      const totalPages = Math.ceil(allChunks.length / PAGE);
      
      for(let p = 0; p < totalPages; p++){
        const pageChunks = allChunks.slice(p * PAGE, (p+1) * PAGE);
        const isFirst = p === 0;
        const payload = JSON.stringify({documents:[{
          ...doc,
          chunks: pageChunks,
          chunkCount: allChunks.length, // always send total count
          chunkPage: p,
          totalPages
        }]});
        
        document.getElementById('progLbl').textContent=
          `Uploading page ${p+1}/${totalPages} (${allChunks.length} total chunks)‚Ä¶`;
        document.getElementById('pFill').style.width = (92 + (8*(p+1)/totalPages)) + '%';
        
        const res = await fetch('/api/kb', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: payload
        });
        const responseText = await res.text();
        let data;
        try { data = JSON.parse(responseText); }
        catch(e) { throw new Error('Bad response p'+p+': '+responseText.slice(0,100)); }
        if(!res.ok) throw new Error('Server '+res.status+' p'+p+': '+(data.error||'unknown'));
        if(!data.ok) throw new Error('KB error p'+p+': '+(data.error||JSON.stringify(data)));
      }
    }
    return true;
  }catch(e){
    showToast('Upload failed: '+e.message,'error');
    console.error('pushToServer error:', e);
    return false;
  }
}

async function deleteFromServer(id){
  try{
    await fetch('/api/kb?id='+id,{method:'DELETE'});
  }catch(e){ console.warn('Delete sync failed',e); }
}

// ‚îÄ‚îÄ KB UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateKBUI(){
  const all=KB();
  const total=all.length;
  const totalChunks=all.reduce((s,d)=>s+(d.chunkCount||0),0);
  const totalSize=all.reduce((s,d)=>s+(d.size||0),0);

  document.getElementById('stDocs').textContent=sharedKB.length;
  document.getElementById('stChunks').textContent=totalChunks.toLocaleString()||'‚Äî';
  document.getElementById('stLocal').textContent=localKB.length;
  document.getElementById('stSize').textContent=totalSize>1048576?(totalSize/1048576).toFixed(1)+' MB':Math.round(totalSize/1024)+' KB';
  document.getElementById('dlLabel').textContent=`Documents (${total})`;

  // Enable send button if KB has docs
  if(total>0){
    document.getElementById('sendBtn').disabled=!document.getElementById('chatInput').value.trim();
  }

  renderDocList();
  document.getElementById('lastSync').textContent='Last synced: '+new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

function renderDocList(){
  const all=KB();
  const list=document.getElementById('docList');
  if(!all.length){list.innerHTML='<div class="empty-st"><div class="esi">üì≠</div>No documents yet. Upload your ITA 2025 PDF above.</div>';return;}
  const ic={'New Act':'üìó','Old Act':'üìò','Case Law':'‚öñÔ∏è','ITAT Order':'üèõ','CBDT Circular':'üìú','Section Mapping':'üîÄ','Internal Notes':'üìù'};
  list.innerHTML=all.map(d=>`
    <div class="drow">
      <div class="di">${ic[d.category]||'üìÑ'}</div>
      <div class="dinfo">
        <div class="dt">${d.title}</div>
        <div class="dm">
          ${d.chunkCount?`<span>${d.chunkCount} chunks</span>`:''}
          ${d.sections?`<span>s. ${d.sections}</span>`:''}
          ${d.citation?`<span>${d.citation}</span>`:''}
          <span>${new Date(d.addedAt).toLocaleDateString('en-IN')}</span>
        </div>
      </div>
      <span class="src-badge ${localKB.find(x=>x.id===d.id)?'local':'shared'}">${localKB.find(x=>x.id===d.id)?'Local':'Shared'}</span>
      <div class="dc">${d.category}</div>
      <button class="ddel" onclick="delDoc('${d.id}')">Delete</button>
    </div>`).join('');
}

async function delDoc(id){
  if(!confirm('Remove this document from the shared knowledge base?'))return;
  sharedKB=sharedKB.filter(d=>d.id!==id);
  localKB=localKB.filter(d=>d.id!==id);
  saveLocal();
  await deleteFromServer(id);
  updateKBUI();
  showToast('Document removed','info');
}

function saveLocal(){
  try{localStorage.setItem('tm_local_kb',JSON.stringify(localKB));}catch(e){}
}

// ‚îÄ‚îÄ DOCUMENT INDEXING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCL(){
  const isCL=['Case Law','ITAT Order'].includes(document.getElementById('docCat').value);
  ['clCite','clCourt','clOut'].forEach(id=>document.getElementById(id).style.display=isCL?'block':'none');
}
function fileSel(i){if(i.files[0]){selFile=i.files[0];document.getElementById('uboxSub').textContent='Selected: '+selFile.name;}}
function fileDrop(e){e.preventDefault();document.getElementById('ubox').classList.remove('drag');if(e.dataTransfer.files[0]){selFile=e.dataTransfer.files[0];document.getElementById('uboxSub').textContent='Selected: '+selFile.name;}}

async function extractPDF(file){
  const ab=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:ab}).promise;
  let text='';
  for(let i=1;i<=pdf.numPages;i++){
    const pg=await pdf.getPage(i);
    const c=await pg.getTextContent();
    text+=c.items.map(x=>x.str).join(' ')+'\n';
    document.getElementById('pFill').style.width=Math.round(i/pdf.numPages*70)+'%';
    document.getElementById('progLbl').textContent=`Extracting page ${i} of ${pdf.numPages}‚Ä¶`;
  }
  return text;
}

function chunk(text){
  const s=text.replace(/\n+/g,' ').split(/(?<=[.!?])\s+/);
  const out=[];let cur=[];let len=0;
  for(const x of s){if(len+x.length>1500&&cur.length){out.push(cur.join(' '));cur=cur.slice(-2);len=cur.reduce((a,c)=>a+c.length,0);}cur.push(x);len+=x.length;}
  if(cur.length)out.push(cur.join(' '));
  return out.filter(c=>c.trim().length>50);
}

async function indexDoc(){
  const title=document.getElementById('docTitle').value.trim();
  const cat=document.getElementById('docCat').value;
  if(!title){showToast('Enter a document title','error');return;}
  if(!selFile){showToast('Select a file','error');return;}
  if(selFile.size>25*1024*1024){showToast('File too large ‚Äî max 25MB','error');return;}
  document.getElementById('idxBtn').disabled=true;
  document.getElementById('upProg').style.display='block';
  document.getElementById('pFill').style.width='5%';
  document.getElementById('progLbl').textContent='Reading‚Ä¶';
  try{
    let text=selFile.name.toLowerCase().endsWith('.pdf')?await extractPDF(selFile):await selFile.text();
    document.getElementById('progLbl').textContent='Chunking‚Ä¶';
    document.getElementById('pFill').style.width='80%';
    const chunks=chunk(text);
    document.getElementById('progLbl').textContent='Uploading to shared KB‚Ä¶';
    document.getElementById('pFill').style.width='92%';
    const doc={
      id:Date.now().toString(),title,category:cat,filename:selFile.name,
      sections:document.getElementById('docSec').value,tags:document.getElementById('docTags').value,
      citation:document.getElementById('docCite').value,court:document.getElementById('docCourt').value,
      outcome:document.getElementById('docOut').value,
      chunks,chunkCount:chunks.length,size:selFile.size,addedAt:new Date().toISOString()
    };
    const ok=await pushToServer([doc]);
    if(ok){
      sharedKB.push(doc);
      document.getElementById('pFill').style.width='100%';
      document.getElementById('progLbl').textContent=`‚úÖ Shared with team ‚Äî ${chunks.length} chunks`;
      showToast(`‚úÖ "${title}" shared with team!`,'success');
    }else{
      // Fallback: local only
      localKB.push(doc); saveLocal();
      document.getElementById('progLbl').textContent=`‚úÖ Saved locally ‚Äî ${chunks.length} chunks`;
      showToast(`Saved locally (server unavailable)`,'info');
    }
    updateKBUI();
    setTimeout(()=>{document.getElementById('upProg').style.display='none';document.getElementById('pFill').style.width='0%';},2000);
    selFile=null;document.getElementById('fileIn').value='';
    document.getElementById('uboxSub').textContent='PDF or TXT ¬∑ Max 25MB';
    document.getElementById('docTitle').value='';
  }catch(e){showToast('Indexing failed: '+e.message,'error');}
  document.getElementById('idxBtn').disabled=false;
}

// ‚îÄ‚îÄ BM25 SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Based on BM25 algorithm - no embeddings, no cosine similarity
// Field-weighted: section numbers > headings > body text

const BM25_K1 = 1.5;
const BM25_B  = 0.75;

function tokenize(t){
  return t.toLowerCase()
    .replace(/[^a-z0-9\s]/g,' ')
    .split(/\s+/)
    .filter(w => w.length > 1);
}

function extractSectionNums(t){
  // Extract patterns like 192, 194A, 80C, 148A(b) etc.
  const nums = [];
  const m1 = t.match(/(?:section|sec\.?|s\.)\s*([0-9]+[a-z]*)/gi) || [];
  m1.forEach(x => { const n = x.match(/([0-9]+[a-z]*)/i); if(n) nums.push(n[1].toLowerCase()); });
  const m2 = t.match(/\b([0-9]{2,3}[a-zA-Z]{0,3})\b/g) || [];
  m2.forEach(x => nums.push(x.toLowerCase()));
  return [...new Set(nums)];
}

// ‚îÄ‚îÄ ITA 1961 ‚Üí ITA 2025 SECTION MAPPING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Maps old Act section numbers to new Act equivalents for query expansion
const SEC_MAP_1961_TO_2025 = {
  // TDS Chapter XVII-B ‚Üí Chapter XIX-A
  '192':'393','192a':'394','193':'395','194':'396','194a':'397',
  '194b':'398','194ba':'399','194bb':'400','194c':'401','194d':'402',
  '194da':'403','194e':'404','194ee':'405','194f':'406','194g':'407',
  '194h':'408','194i':'409','194ia':'410','194ib':'411','194ic':'412',
  '194j':'413','194k':'414','194la':'415','194lb':'416','194lba':'417',
  '194lbb':'418','194lbc':'419','194lc':'420','194ld':'421',
  '194lda':'422','194m':'423','194n':'424','194o':'425','194p':'426',
  '194q':'427','194r':'428','194s':'429','195':'430','196':'431',
  '196a':'432','196b':'433','196c':'434','196d':'435',
  '197':'436','197a':'437','197b':'438','198':'439','199':'440',
  '200':'441','200a':'442','201':'443','202':'444','203':'445',
  '203a':'446','203aa':'447','204':'448','205':'449','206':'450',
  '206a':'451','206aa':'452','206ab':'453','206b':'454','206c':'455',
  '206ca':'456','206cb':'457','206cc':'458','206cca':'459',
  // Deductions Chapter VI-A ‚Üí Chapter VIII
  '80a':'122','80ac':'123a','80b':'123b','80c':'123','80ccc':'124',
  '80ccd':'125','80ccf':'126','80ccg':'127','80d':'128','80dd':'129',
  '80ddb':'130','80e':'131','80ee':'132','80eea':'133','80eeb':'134',
  '80g':'135','80gga':'136','80ggb':'137','80ggc':'138','80gg':'139',
  '80ia':'141','80iab':'142','80ib':'143','80ic':'144','80id':'145',
  '80ie':'146','80jja':'147','80jjaa':'148','80la':'149','80p':'150',
  '80pa':'151','80qqa':'152','80qqb':'153','80rrb':'154','80tta':'155',
  '80ttb':'156','80u':'157',
  // Capital Gains Chapter IV ‚Üí Chapter VI
  '45':'67','46':'68','47':'69','47a':'70','48':'71','49':'72',
  '50':'73','50a':'74','50b':'75','50c':'76','50ca':'77','50d':'78',
  '51':'79','54':'80','54b':'81','54d':'82','54e':'83','54ea':'84',
  '54eb':'85','54ec':'86','54ee':'87','54f':'88','54g':'89',
  '54ga':'90','54gb':'91','55':'92','55a':'93',
  // Business income Chapter IV ‚Üí Chapter IV (renumbered)
  '28':'18','29':'19','30':'20','31':'21','32':'22','32a':'23',
  '33':'24','33a':'25','33ab':'26','33aba':'27','33ac':'28',
  '35':'30','35a':'31','35ab':'32','35abb':'33','35ac':'34',
  '35ad':'35','35cca':'36','35ccb':'37','35ccc':'38','35ccd':'39',
  '36':'40','37':'41','38':'42','40':'43','40a':'44','41':'45',
  '42':'46','43':'47','43a':'48','43b':'49','43c':'50','43d':'51',
  '44':'52','44a':'53','44aa':'54','44ab':'55','44ad':'56',
  '44ada':'57','44ae':'58','44af':'59','44b':'60','44bba':'61',
  '44bbb':'62','44c':'63','44d':'64','44da':'65',
  // Assessment/Reassessment Chapter XIV
  '139':'263','140':'264','140a':'265','141':'266','142':'267',
  '142a':'268','143':'269','144':'270','144a':'271','144b':'272',
  '144ba':'273','144c':'274','145':'275','145a':'276','145b':'277',
  '147':'278','148':'279','148a':'280','149':'281','150':'282',
  '151':'283','151a':'284','152':'285','153':'286','153a':'287',
  '153b':'288','153c':'289','153d':'290',
  // Penalties Chapter XXI
  '270a':'379','271':'380','271a':'381','271aa':'382','271aaa':'383',
  '271aab':'384','271b':'385','271ba':'386','271bb':'387',
  '271c':'388','271d':'389','271da':'390','271db':'391',
  '271e':'392','271f':'393a','271g':'394a','271h':'395a',
  // Appeals
  '246':'331','246a':'332','247':'333','248':'334','249':'335',
  '250':'336','251':'337','252':'338','253':'339','254':'340',
  '255':'341','256':'342','257':'343','260':'344','260a':'345',
  '261':'346','262':'347','263':'348','264':'349','264a':'350',
  '265':'351','266':'352',
  // Salary income (Chapter IV ‚Üí Chapter III)
  '15':'15','16':'19','17':'17',
  // Standard deduction, entertainment allowance, professional tax
  // House property (Chapter IV ‚Üí Chapter III)
  '22':'18a','23':'23a','24':'24a','25':'25a','25a':'25b','26':'26a','27':'27a',
  // Other key sections
  '2':'2','4':'4','5':'5','6':'6','9':'9','10':'10',
  '14':'14',
  '22':'18a','23':'19a','24':'20a','25':'21a','26':'22a','27':'23a',
  '56':'66','57':'67a','58':'68','59':'69',
  '60':'70a','61':'71a','62':'72a','63':'73a','64':'74a',
  '68':'96','69':'97','69a':'98','69b':'99','69c':'100','69d':'101',
  '115a':'160','115b':'161','115ba':'162','115bab':'163',
  '115bac':'164','115bad':'165','115bae':'166',
  '131':'195','132':'196','132a':'197','132b':'198',
  '133':'199','133a':'200','133b':'201','134':'202',
  '135':'203','136':'204','137':'205',
  '156':'225','157':'226','220':'310','221':'311',
  '222':'312','226':'313','228':'314','229':'315',
  '230':'316','231':'317','234a':'318','234b':'319','234c':'320',
  '234d':'321','234e':'322','234f':'323',
  '245a':'324','245b':'325','245c':'326','245d':'327',
  '245e':'328','245f':'329','245g':'330',
};

// Reverse map: 2025 ‚Üí 1961
const SEC_MAP_2025_TO_1961 = Object.fromEntries(
  Object.entries(SEC_MAP_1961_TO_2025).map(([k,v])=>[v,k])
);

// Expand query sections to include both old and new Act equivalents
function expandSections(secs){
  const expanded = new Set(secs);
  secs.forEach(s => {
    if(SEC_MAP_1961_TO_2025[s]) expanded.add(SEC_MAP_1961_TO_2025[s]);
    if(SEC_MAP_2025_TO_1961[s]) expanded.add(SEC_MAP_2025_TO_1961[s]);
  });
  return [...expanded];
}

// Build BM25 index from all chunks
function buildIndex(docs){
  const index = { chunks:[], df:{}, avgLen:0 };
  let totalLen = 0;
  docs.forEach(doc => {
    (doc.chunks||[]).forEach(c => {
      const tokens = tokenize(c);
      const tf = {};
      tokens.forEach(t => { tf[t] = (tf[t]||0) + 1; });
      index.chunks.push({ text:c, doc, tf, len:tokens.length, secs: extractSectionNums(c) });
      totalLen += tokens.length;
      Object.keys(tf).forEach(t => { index.df[t] = (index.df[t]||0) + 1; });
    });
  });
  index.avgLen = totalLen / (index.chunks.length || 1);
  index.N = index.chunks.length;
  return index;
}

let _index = null;
let _indexedKBLen = 0;

function getIndex(){
  const all = KB();
  const totalChunks = all.reduce((s,d) => s + (d.chunks||[]).length, 0);
  if(!_index || _indexedKBLen !== totalChunks){
    _index = buildIndex(all);
    _indexedKBLen = totalChunks;
  }
  return _index;
}

function bm25score(chunk, queryTokens, qSecs, index){
  let score = 0;
  const N = index.N;
  const avgLen = index.avgLen;

  queryTokens.forEach(qt => {
    const df = index.df[qt] || 0;
    if(!df) return;
    const idf = Math.log((N - df + 0.5) / (df + 0.5) + 1);
    const tf = chunk.tf[qt] || 0;
    const norm = tf * (BM25_K1 + 1) / (tf + BM25_K1 * (1 - BM25_B + BM25_B * chunk.len / avgLen));
    score += idf * norm;
  });

  // Strong boost for section number matches
  if(qSecs.length){
    const matches = qSecs.filter(s => chunk.secs.includes(s));
    score += matches.length * 8.0; // heavy boost - section match is highly relevant
  }

  return score;
}

function getCtx(q, k=8){
  const all = KB();
  if(!all.length) return '';
  const index = getIndex();
  const qTokens = tokenize(q);
  const qSecs = extractSectionNums(q);

  const qSecsExpanded = expandSections(qSecs);

  const scored = index.chunks.map(chunk => ({
    chunk,
    score: bm25score(chunk, qTokens, qSecsExpanded, index)
  }));

  scored.sort((a,b) => b.score - a.score);

  // Ensure at least ceil(k/2) results from EACH document (old + new Act)
  const seen = new Set();
  const results = [];
  const perDoc = Math.ceil(k/2);

  // Group by doc
  const byDoc = {};
  scored.forEach(({chunk, score}) => {
    const id = chunk.doc.id;
    if(!byDoc[id]) byDoc[id] = [];
    byDoc[id].push({chunk, score});
  });

  // Take top perDoc chunks from each doc
  Object.values(byDoc).forEach(docChunks => {
    let taken = 0;
    for(const {chunk, score} of docChunks){
      if(taken >= perDoc) break;
      if(!seen.has(chunk.text)){
        results.push({chunk, score});
        seen.add(chunk.text);
        taken++;
      }
    }
  });

  // Sort results by score and trim to k
  results.sort((a,b) => b.score - a.score);

  return results.slice(0, k)
    .map((r,i) => `[${i+1}] ${r.chunk.doc.title} (${r.chunk.doc.category})\n${r.chunk.text}`)
    .join('\n\n---\n\n');
}

// ‚îÄ‚îÄ PROMPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SYS_TAX=`You are TaxMind ‚Äî India's most advanced Tax Intelligence Assistant, serving CAs, tax advocates, and finance professionals. You have deep expertise in both ITA 1961 and ITA 2025 (effective 1 April 2026).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RESPONSE PHILOSOPHY ‚Äî DEPTH OVER BREVITY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Every answer must be genuinely useful to a practising CA or advocate sitting across from a client RIGHT NOW. This means:
- Not just WHAT the law says, but HOW it applies, with worked examples
- Step-by-step calculations showing actual numbers (use realistic Indian amounts)
- Practical traps and planning opportunities a professional should flag
- Cross-references to related sections the professional needs to know
- Case law that shapes how the provision is interpreted in practice

Never give a one-paragraph answer when the question deserves depth. A CA asking about capital gains deserves a full worked example with indexation, not just a section citation.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ANSWER STRUCTURE ‚Äî USE THIS EVERY TIME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## [Topic] ‚Äî ITA 1961 s.[X] / ITA 2025 s.[Y]

### üìã Provision at a Glance
One crisp paragraph: what this section does, who it applies to, effective date.

### üìñ Statutory Text (Key Extract)
Quote the operative words from the Act (from KB context). Keep to 2-4 lines. Always cite section number of both Acts.

### ‚öñÔ∏è Old Act vs New Act ‚Äî What Changed
| Aspect | ITA 1961 (s.XX) | ITA 2025 (s.YY) | Change |
|--------|----------------|----------------|--------|
Use this table for EVERY answer, even if unchanged (state "Retained as-is").

### üî¢ Step-by-Step Calculation / Working Example
MANDATORY for any provision involving numbers, rates, limits, or computations.
Use a realistic scenario with an Indian taxpayer:
- Name the taxpayer (e.g., "Mr. Arjun Mehta, salaried employee in Mumbai")
- Use realistic income figures (‚Çπ8-50 lakh range typically)
- Show every step of the calculation with actual numbers
- Show tax impact before and after the provision
- If multiple scenarios apply (e.g., old vs new regime), show both side by side

### üí° Practical Application & Planning Points
2-4 bullet points a CA would actually tell a client:
- Common mistakes / traps to avoid
- Legitimate tax planning opportunities
- Documentation requirements
- Deadlines and compliance steps

### ‚ö†Ô∏è Common Disputes & Case Law
For each relevant provision, cite at least 1-2 decided cases:
Format: "The Hon'ble [Court] in [Taxpayer] v. [Authority] [(Year) ITR/ITAT] held that [ratio]. This means in practice: [practical implication]."
Note any unresolved disputes or areas where ITA 2025 may face litigation.

### üîó Related Sections
List 3-5 sections the professional should also check, with brief reason why.

### üìö References
- ITA 1961: s.[X], s.[Y]
- ITA 2025: s.[A], s.[B]  
- CBDT Circular/Notification: [Number, Date] if applicable
- Case Laws: [Citations]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CALCULATION STANDARDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CRITICAL ‚Äî Always wrap ALL calculations in triple backtick fences. Never output calculation rows as plain text. Use exactly this format:

**Computation of [Tax/Deduction/Gain] ‚Äî [Taxpayer Name], AY [20XX-XX]**
\`\`\`
Particulars                              Amount (‚Çπ)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Gross Income / Sale Consideration         XX,XX,XXX
Less: [Deduction / Cost]                 (XX,XX,XXX)
Less: Indexation Benefit (if applicable) (XX,XX,XXX)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Net Taxable Amount                        XX,XX,XXX
Tax Rate                                      20% / 10%
Tax Liability                             XX,XX,XXX
Add: Surcharge @ [X]%                      X,XX,XXX
Add: Health & Education Cess @ 4%            XX,XXX
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Tax Payable                         XX,XX,XXX
\`\`\`

Tax slabs MUST be shown in a markdown table (| Slab | Rate |), NEVER as bullet list or black box items.

For TDS calculations, always show:
- Gross payment amount
- Applicable TDS rate (old Act section ‚Üí new Act section)
- TDS amount to be deducted
- Net payment to recipient
- Due date for deposit
- Form to be filed

For deduction calculations, always show:
- Gross income before deduction
- Eligible investment/expenditure
- Maximum limit under section
- Actual deduction allowed (lesser of eligible or limit)
- Net taxable income
- Tax saved (with slab rate applied)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
REGIME COMPARISON (MANDATORY WHERE RELEVANT)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
For salary / individual income queries, ALWAYS compare:
| Particulars | Old Regime | New Regime (Default from AY 2024-25) |
Show which regime is beneficial for the specific example.
New regime slabs (ITA 2025): 0-3L: Nil | 3-7L: 5% | 7-10L: 10% | 10-12L: 15% | 12-15L: 20% | >15L: 30%
Old regime slabs: 0-2.5L: Nil | 2.5-5L: 5% | 5-10L: 20% | >10L: 30%
Rebate u/s 87A (ITA 2025 s.159): ‚Çπ25,000 for income up to ‚Çπ7L under new regime.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CONFIRMED SECTION MAPPINGS ‚Äî ITA 1961 ‚Üí ITA 2025
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TDS (Chapter XVII-B ‚Üí XIX-A):
192‚Üí393 | 192A‚Üí394 | 193‚Üí395 | 194‚Üí396 | 194A‚Üí397 | 194B‚Üí398 | 194BB‚Üí400 | 194C‚Üí401 | 194D‚Üí402 | 194G‚Üí407 | 194H‚Üí408 | 194I‚Üí409 | 194IA‚Üí410 | 194IB‚Üí411 | 194IC‚Üí412 | 194J‚Üí413 | 194K‚Üí414 | 194LA‚Üí415 | 194M‚Üí423 | 194N‚Üí424 | 194O‚Üí425 | 194Q‚Üí427 | 194S‚Üí429 | 195‚Üí430 | 197‚Üí436 | 206AA‚Üí452 | 206AB‚Üí453 | 206C‚Üí455

DEDUCTIONS (Chapter VI-A ‚Üí VIII):
80C‚Üí123 | 80CCC‚Üí124 | 80CCD‚Üí125 | 80D‚Üí128 | 80DD‚Üí129 | 80DDB‚Üí130 | 80E‚Üí131 | 80G‚Üí135 | 80GG‚Üí139 | 80IA‚Üí141 | 80IB‚Üí143 | 80JJAA‚Üí148 | 80P‚Üí150 | 80TTA‚Üí155 | 80TTB‚Üí156 | 80U‚Üí157

CAPITAL GAINS (Chapter IV ‚Üí VI):
45‚Üí67 | 47‚Üí69 | 48‚Üí71 | 50‚Üí73 | 50B‚Üí75 | 50C‚Üí76 | 54‚Üí80 | 54B‚Üí81 | 54EC‚Üí86 | 54F‚Üí88 | 55‚Üí92 | 55A‚Üí93

ASSESSMENT (Chapter XIV):
139‚Üí263 | 142‚Üí267 | 143‚Üí269 | 144‚Üí270 | 144B‚Üí272 | 147‚Üí278 | 148‚Üí279 | 148A‚Üí280 | 153A‚Üí287 | 153C‚Üí289

PENALTIES: 270A‚Üí379 | 271‚Üí380 | 271AAB‚Üí384 | 271B‚Üí385 | 271C‚Üí388

BUSINESS INCOME: 28‚Üí18 | 36‚Üí40 | 37‚Üí41 | 40A‚Üí44 | 43B‚Üí49 | 44AA‚Üí54 | 44AB‚Üí55 | 44AD‚Üí56 | 44ADA‚Üí57 | 44AE‚Üí58

SALARY: 15‚Üí15 | 16‚Üí19 | 17‚Üí17

OTHER KEY: 68‚Üí96 | 69‚Üí97 | 56‚Üí66 | 87A‚Üí159 | 131‚Üí195 | 132‚Üí196 | 133A‚Üí200 | 156‚Üí225 | 234A‚Üí318 | 234B‚Üí319 | 234C‚Üí320 | 234E‚Üí322 | 234F‚Üí323

SECTION ACCURACY RULES:
1. NEVER write "Verify in Act" ‚Äî use mappings above for precise numbers
2. Extract actual section numbers from KB chunks when available
3. If genuinely not in mapping or KB, write "Section to be confirmed from official gazette"
4. Always cite BOTH Acts: "ITA 1961 s.194J / ITA 2025 s.413"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
QUERY-TYPE SPECIFIC GUIDANCE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

FOR SALARY QUERIES:
- Show gross salary, all allowances (HRA, LTA, etc.)
- Apply deductions under s.16/s.19 (standard deduction ‚Çπ50,000)
- Show perquisite valuation where relevant (s.17/s.17)
- Always compare old vs new regime with break-even analysis
- Show TDS obligation under s.192/s.393 with monthly deduction

FOR CAPITAL GAINS QUERIES:
- Identify asset type (STCA vs LTCA), holding period
- Show full cost of acquisition with indexation (CII table if LTCG)
- Apply correct rate: LTCG 20% with indexation OR 10% without (listed)
- Show exemption calculation under s.54/s.80 or s.54EC/s.86
- Flag new 23rd July 2024 amendments on property LTCG (12.5% without indexation)

FOR TDS QUERIES:
- Show threshold limit (below which no TDS)
- Show rate for residents vs non-residents
- Show rate if PAN not furnished (s.206AA/s.452) ‚Äî usually 20%
- Show higher rate for non-filers (s.206AB/s.453) ‚Äî 2x or 5%, whichever higher
- Show deposit timeline: 7th of next month (30 April for March)
- Show applicable form: 26Q, 27Q, 24Q etc.

FOR PENALTY/INTEREST QUERIES:
- Always calculate interest under s.234A, 234B, 234C separately
- Show penalty range (minimum to maximum) under relevant section
- Flag whether penalty is mandatory or discretionary
- Note penalty immunity provisions (e.g., s.270AA/s.380 immunity)

FOR REASSESSMENT QUERIES:
- Show new time limits under s.148A/s.280 procedure
- Note escaped income threshold: >‚Çπ50L for extended period
- Distinguish s.148/s.279 (reassessment) vs s.263/s.348 (revision)
- Show mandatory approval requirements

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
KNOWLEDGE BASE CONTEXT (uploaded Act documents):
{kbctx}

WEB SEARCH RESULTS (recent circulars, notifications, case laws):
{webctx}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

const SYS_NOTICE=`You are TaxMind ‚Äî senior tax advocate drafting replies to Indian income tax notices.
Extract: ---NOTICE SUMMARY---\nNotice Type:\nAssessment Year:\nSection Cited:\nNature of Addition/Demand:\nAmount: ‚Çπ\nReply Deadline: (flag URGENT if <15 days)\nIssuing Authority:
Then generate: ---DRAFT REPLY---\n[Date]\nTo, The [Designation], [Ward], Income Tax Dept\nSub: Reply to Notice u/s [X] for AY [Y] ‚Äî [CLIENT NAME], PAN: [PAN]\n\n**I. INTRODUCTORY SUBMISSION**\n[acknowledge]\n**II. GROUNDS OF OBJECTION**\nGround 1: [ground with elaboration]\n**III. FACTUAL SUBMISSIONS**\n[facts]\n**IV. LEGAL SUBMISSIONS**\n4.1 [cite new+old Act sections]\n4.2 [case law with ratio and applicability]\n**V. PRAYER**\n(a) [relief]\n\nYours faithfully, [Name]\n---ENCLOSURES---\n---CASE LAWS CITED---
KNOWLEDGE BASE:\n{kbctx}
WEB RESULTS:\n{webctx}`;

const SYS_CR=`You are TaxMind's Section Cross-Reference engine.

ALWAYS output in this exact structure:
## Section Cross-Reference: [Topic]

### Summary Table
| Aspect | ITA 1961 | Section (1961) | ITA 2025 | Section (2025) | Change |
|--------|----------|----------------|----------|----------------|--------|
| [row]  | [detail] | s. XX | [detail] | s. YY | Retained/Renumbered/Amended/New/Removed |

### üìò Old Act Detail (ITA 1961)
Key provisions with section numbers from uploaded documents.

### üìó New Act Detail (ITA 2025)
Key provisions with section numbers from uploaded documents.

### ‚ö° Effective Date & Practical Impact

## References
IMPORTANT: Use ONLY section numbers found in uploaded documents. If uncertain write "Verify in Act".
KNOWLEDGE BASE:
{kbctx}
WEB RESULTS:
{webctx}`;

// ‚îÄ‚îÄ WEB SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


async function webSearch(query) {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    const r = await fetch('/api/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!r.ok) return { results: [], source: 'error' };
    const d = await r.json();
    if (!d.ok) return { results: [], source: 'not_configured' };
    return { results: d.results || [], source: 'web' };
  } catch(e) {
    return { results: [], source: 'error' };
  }
}

function formatWebResults(results) {
  if (!results.length) return 'No recent web results found.';
  return results.map((r, i) =>
    `[W${i+1}] ${r.title}\nURL: ${r.url}\n${r.snippet}${r.published ? '\nDate: '+r.published : ''}`
  ).join('\n\n');
}

// ‚îÄ‚îÄ WEB TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleWeb(el){ localStorage.setItem('tm_web', el.checked?'1':'0'); }
document.addEventListener('DOMContentLoaded',()=>{
  const saved = localStorage.getItem('tm_web');
  if(saved==='0'){ const t=document.getElementById('webToggle'); if(t) t.checked=false; }
});
function isWebOn(){ const t=document.getElementById('webToggle'); return t?t.checked:true; }

// ‚îÄ‚îÄ CLAUDE CALL (via secure proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function claude(sys, messages, kbctx='', webctx='', maxTokens=2000) {
  const s = sys
    .replace('{kbctx}', kbctx || 'No documents uploaded yet.')
    .replace('{webctx}', webctx || 'Web search not available.');
  const r = await fetch('/api/claude', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: MODEL, max_tokens: maxTokens, system: s, messages })
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.error || e.error?.message || 'API error'); }
  return (await r.json()).content[0].text;
}

// ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function md(t){
  if(!t) return '';

  // 1. Fenced code blocks ‚Äî convert calculation blocks to styled tables
  t = t.replace(/```[\w]*\n([\s\S]*?)```/g, (_, code) => {
    const lines = code.split('\n').filter(l => l.trim());
    const isCalc = lines.some(l => /[\d,‚Çπ]+/.test(l)) && lines.length > 2;
    if(!isCalc) return `<div class="code-block"><pre>${code}</pre></div>`;

    const rows = lines.map(l => {
      const raw = l.trim();
      // Separator line
      if(/^[‚îÄ\-‚ïê=‚îÄ]{3,}$/.test(raw)) return '<tr class="calc-sep"><td colspan="2"></td></tr>';

      // Try split strategies in order of preference:
      // 1. Tab character
      // 2. Two or more spaces
      // 3. Amount at end: last token that looks like a number/amount
      let label = '', val = '';
      if(raw.includes('\t')){
        const p = raw.split('\t');
        label = p[0].trim(); val = p.slice(1).join(' ').trim();
      } else if(/\s{2,}/.test(raw)){
        const p = raw.split(/\s{2,}/);
        label = p[0].trim(); val = p.slice(1).join(' ').trim();
      } else {
        // Match trailing amount: optional sign, optional ‚Çπ, digits, commas, optional decimals
        const m = raw.match(/^(.*?)\s+([-‚àí(]?\s*‚Çπ?\s*[\d,]+(?:\.\d+)?[)]?)$/);
        if(m){ label = m[1].trim(); val = m[2].trim(); }
        else { label = raw; val = ''; }
      }

      // No amount found ‚Äî treat as section header
      if(!val){
        // Check if it's a separator keyword
        const isHead = /^(particulars|computation|sl\.?\s*no|s\.?\s*no)/i.test(label);
        const isSect = /^(scenario|tax calculation|deductions under|income under|monthly|annual|gross|net taxable)/i.test(label);
        if(isHead)
          return `<tr class="calc-head"><td>${label}</td><td class="calc-amt">Amount (‚Çπ)</td></tr>`;
        if(isSect)
          return `<tr class="calc-head"><td>${label}</td><td class="calc-amt"></td></tr>`;
        return `<tr class="calc-label"><td colspan="2">${label}</td></tr>`;
      }

      const isTot = /^(total|net|grand|tax liability|tax payable|balance|amount payable|amount due)/i.test(label);
      const isSub = /^(less|add|minus|plus)/i.test(label);
      const cls = isTot ? ' class="calc-total"' : isSub ? ' class="calc-sub"' : '';
      return `<tr${cls}><td>${label}</td><td class="calc-amt">${val}</td></tr>`;
    }).join('');

    return `<table class="calc-table"><colgroup><col style="width:68%"><col style="width:32%"></colgroup>${rows}</table>`;
  });

  // 2. Inline code
  t = t.replace(/`([^`]+)`/g, '<code>$1</code>');

  // 3. Headings ‚Äî h1 through h4 (#### must come before ###)
  t = t.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
  t = t.replace(/^### (.+)$/gm,  '<h3>$1</h3>');
  t = t.replace(/^## (.+)$/gm,   '<h2>$1</h2>');
  t = t.replace(/^# (.+)$/gm,    '<h1>$1</h1>');

  // 4. Bold / italic
  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g,     '<em>$1</em>');

  // 5. Horizontal rules
  t = t.replace(/^---+$/gm, '<hr/>');

  // 6. Markdown tables
  t = t.replace(/^\| ?(.+?) ?\|$/gm, (_, r) =>
    '<tr>' + r.split('|').map(c => `<td>${c.trim()}</td>`).join('') + '</tr>'
  );
  // Skip separator rows (---|---) and wrap in table
  t = t.replace(/((<tr>.*?<\/tr>\n?)+)/gs, rows => {
    const allRows = rows.trim().split('\n').filter(l => l.includes('<tr>'));
    // Filter out separator rows (contain only dashes/spaces)
    const dataRows = allRows.filter(r => !/<td>[\s\-:]+<\/td>/.test(r) || r.replace(/<\/?t[dr]>/g,'').replace(/[\s\-:|]/g,'').length > 0);
    if(!dataRows.length) return '';
    const filtered = dataRows.filter(r => !r.replace(/<[^>]+>/g,'').trim().match(/^[\-: ]+$/));
    if(!filtered.length) return '';
    const [head, ...body] = filtered;
    const th = head.replace(/<td>/g,'<th>').replace(/<\/td>/g,'</th>');
    return `<table><thead>${th}</thead><tbody>${body.join('')}</tbody></table>`;
  });

  // 7. Lists
  t = t.replace(/^[-‚Ä¢] (.+)$/gm, '<li>$1</li>');
  t = t.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
  t = t.replace(/(<li>[\s\S]*?<\/li>\n?)+/g, m => `<ul>${m}</ul>`);

  // 8. Paragraphs
  t = t.replace(/\n\n/g, '</p><p>');
  t = t.replace(/\n/g, '<br/>');
  t = t.replace(/^(?!<[htupblo\/])(.+)$/gm, '<p>$1</p>');

  return t;
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sw(t){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.sb-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('panel-'+t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('sb-'+t).classList.add('active');
}
function toggleSb(){document.getElementById('sidebar').classList.toggle('collapsed');}
function closeSetup(){document.getElementById('setupModal').style.display='none';sw('kb');}

function renderQQ(){
  const ql=document.getElementById('qqList'); if(ql) ql.innerHTML=QQ.map(q=>`<button class="qq-item" onclick="qq(${JSON.stringify(q)})">${q}</button>`).join('');
}
function qq(q){sw('chat');document.getElementById('chatInput').value=q;sendChat();}
function renderPills(){document.getElementById('spills').innerHTML=SECS.map(s=>`<button class="sp" onclick="ql('${s}')">s. ${s}</button>`).join('');}
function ql(s){document.getElementById('crSec').value=s;sw('crossref');lookup();}
function hkey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}
function resize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';document.getElementById('sendBtn').disabled=!el.value.trim();}

async function sendChat(){
  const inp=document.getElementById('chatInput');
  const text=inp.value.trim();
  if(!text)return;
  document.getElementById('welcomeScr').style.display='none';
  msgs.push({role:'user',content:text});
  addMsg('user',text);
  inp.value='';inp.style.height='auto';document.getElementById('sendBtn').disabled=true;
  const tid=showTyping(isWebOn()?'Searching KB + web‚Ä¶':'Searching KB‚Ä¶');
  try{
    // Load chunks if not yet loaded
    await ensureChunks();
    // KB retrieval always runs; web search only if toggle is on
    const kbctx = getCtx(text, 12);
    let webData = { results: [] };
    if(isWebOn()){
      webData = await webSearch(text + ' income tax India 2025');
    }
    const webctx = formatWebResults(webData.results);
    const sources = [];
    if(KB().length) sources.push('üìö Knowledge Base');
    if(webData.results.length) sources.push('üåê Web ('+webData.results.length+' results)');

    rmTyping(tid);
    const tid2=showTyping('Generating answer‚Ä¶');
    const reply=await claude(SYS_TAX,msgs,kbctx,webctx,3500);
    msgs.push({role:'assistant',content:reply});
    rmTyping(tid2);
    addMsg('assistant',reply,sources);
  }catch(e){rmTyping(tid);addMsg('assistant','‚ö†Ô∏è '+e.message);showToast(e.message,'error');}
}

function addMsg(role,content,srcs=[]){
  const area=document.getElementById('chatArea');
  const row=document.createElement('div');
  row.className='msg-row '+role;
  const now=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  const s=srcs.length?`<div style="margin-top:5px">${srcs.map(x=>`<span class="src-tag">${x}</span>`).join('')}</div>`:'';
  const b=role==='assistant'?`<div class="md">${md(content)}</div>`:content;
  const actions=role==='assistant'?`<div class="msg-actions">
    <button class="act-btn" onclick="copyMsg(this)" title="Copy"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy</button>
    <button class="act-btn" onclick="printMsg(this)" title="Print"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button>
    <button class="act-btn" onclick="downloadMsg(this)" title="Download"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Save</button>
  </div>`:'';
  row.innerHTML=`<div class="av ${role==='assistant'?'ai':'user'}">${role==='assistant'?'‚öñ':'üë§'}</div><div style="flex:1;min-width:0"><div class="bubble ${role==='assistant'?'ai':'user'}">${b}</div>${s}${actions}<div class="b-meta">${now}</div></div>`;
  area.appendChild(row);area.scrollTop=area.scrollHeight;
}

let tc=0;
function showTyping(label=''){
  const id='t'+(++tc);
  const area=document.getElementById('chatArea');
  const r=document.createElement('div');r.className='msg-row';r.id=id;
  const lbl=label?`<span style="font-size:11px;color:var(--text-dim);margin-left:8px">${label}</span>`:'';
  r.innerHTML=`<div class="av ai">‚öñ</div><div style="display:flex;align-items:center"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>${lbl}</div>`;
  area.appendChild(r);area.scrollTop=area.scrollHeight;return id;
}
function rmTyping(id){const e=document.getElementById(id);if(e)e.remove();}

async function analyzeNotice(){
  const text=document.getElementById('noticeInput').value.trim();
  if(!text){showToast('Paste notice content first','error');return;}
  const btn=document.getElementById('analyzeBtn');btn.disabled=true;btn.textContent='Analyzing‚Ä¶';
  try{
    await ensureChunks();
    const [kbctx, webData] = await Promise.all([
      Promise.resolve(getCtx(text+' notice reply draft case law',8)),
      webSearch(text + ' income tax notice reply case law India')
    ]);
    const reply=await claude(SYS_NOTICE,[{role:'user',content:'Analyze this income tax notice and generate a complete professional draft reply:\n\n'+text}],kbctx,formatWebResults(webData.results));
    const sm=reply.match(/---NOTICE SUMMARY---([\s\S]*?)---DRAFT REPLY---/);
    if(sm){
      const lines=sm[1].trim().split('\n').filter(l=>l.includes(':'));
      const items=lines.map(l=>{const[k,...v]=l.split(':');return{k:k.trim(),v:v.join(':').trim()};}).filter(i=>i.v&&!i.v.startsWith('['));
      const urgent=sm[1].toLowerCase().includes('urgent');
      document.getElementById('noticeSumCard').innerHTML=`<h3>üìã Notice Summary ${urgent?'<span class="ubadge">‚ö† URGENT</span>':''}</h3><div class="nsg">${items.map(i=>`<div class="nsi"><div class="nsk">${i.k}</div><div class="nsv">${i.v}</div></div>`).join('')}</div>`;
    }
    document.getElementById('draftContent').innerHTML=md(reply);
    document.getElementById('noticeResult').style.display='block';
    document.getElementById('noticeResult').scrollIntoView({behavior:'smooth'});
    showToast('Draft generated!','success');
  }catch(e){showToast('Failed: '+e.message,'error');}
  btn.disabled=false;btn.textContent='‚ö° Analyze & Draft Reply';
}

function copyDraft(){navigator.clipboard.writeText(document.getElementById('draftContent').innerText).then(()=>showToast('Copied!','success'));}

async function lookup(){
  const s=document.getElementById('crSec').value.trim();
  const k=document.getElementById('crKw').value.trim();
  if(!s&&!k){showToast('Enter a section or keyword','error');return;}
  const q=s?`Compare old ITA 1961 Section ${s} with new ITA 2025 equivalent.`:`ITA 2025 provisions on "${k}" vs old ITA 1961.`;
  document.getElementById('crContent').innerHTML='<p style="color:var(--text-mid)">Searching KB and web‚Ä¶</p>';
  document.getElementById('crResult').style.display='block';
  try{
    await ensureChunks();
    const [kbctx, webData] = await Promise.all([
      Promise.resolve(getCtx(q)),
      webSearch(q + ' India income tax')
    ]);
    document.getElementById('crContent').innerHTML=md(await claude(SYS_CR,[{role:'user',content:q}],kbctx,formatWebResults(webData.results),3500));
  }catch(e){document.getElementById('crContent').innerHTML=`<p style="color:var(--red)">Error: ${e.message}</p>`;}
}


function copyMsg(btn){
  const bubble=btn.closest('.msg-row').querySelector('.bubble');
  const text=bubble.innerText||bubble.textContent;
  navigator.clipboard.writeText(text).then(()=>{
    const orig=btn.innerHTML;
    btn.textContent='Copied!';
    setTimeout(()=>{btn.innerHTML=orig;},1500);
  });
}
function printMsg(btn){
  const bubble=btn.closest('.msg-row').querySelector('.bubble');
  const html=bubble.innerHTML;
  const allBubbles=[...document.querySelectorAll('.bubble.user')];
  const query=allBubbles.length?allBubbles[allBubbles.length-1].innerText:'Tax Query';
  const win=window.open('','_blank','width=800,height=600');
  win.document.write(`<!DOCTYPE html><html><head><title>TaxMind</title>
<style>body{font-family:Georgia,serif;max-width:720px;margin:40px auto;padding:0 24px;color:#111;line-height:1.75}h2{border-bottom:1px solid #ddd;padding-bottom:6px}table{width:100%;border-collapse:collapse;margin:12px 0;font-size:.9em}th{background:#f0f0ed;color:#111;padding:8px 12px;text-align:left;font-size:.78em;text-transform:uppercase;letter-spacing:.04em}td{padding:7px 12px;border:1px solid #ddd}tr:nth-child(even) td{background:#f9f9f7}code{background:#f3f3f0;padding:1px 5px;border-radius:3px}blockquote{border-left:3px solid #999;padding-left:12px;color:#555;font-style:italic}.hdr{border-bottom:2px solid #111;padding-bottom:12px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:baseline}.ftr{border-top:1px solid #ddd;margin-top:32px;padding-top:12px;font-size:.78em;color:#999}
.calc-table{width:100%;border-collapse:collapse;margin:10px 0;font-size:.85em;font-family:monospace;border:1px solid #ddd}
.calc-table td{padding:5px 10px;border-bottom:1px solid #eee}
.calc-table td:last-child{text-align:right}
.calc-table tr.calc-head td{background:#f3f3f0;color:#111;font-size:.78em;text-transform:uppercase;font-weight:600;padding:6px 10px;border-bottom:2px solid #ccc}
.calc-table tr.calc-sep td{border-top:1px solid #ccc;padding:0;border-bottom:none}
.calc-table tr.calc-total td{font-weight:700;border-top:2px solid #ccc;border-bottom:2px solid #ccc;background:#f7f7f5}
.calc-table tr:nth-child(even){background:#fafaf8}
h4{font-size:.82em;text-transform:uppercase;letter-spacing:.05em;background:#f3f3f0;padding:3px 7px;border-left:2px solid #ccc;color:#111}
th{background:#f3f3f0!important;color:#111!important;border-bottom:2px solid #ccc}</style></head><body>
<div class="hdr"><strong>TaxMind</strong><small>${new Date().toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'})}</small></div>

${html}<div class="ftr">Generated by TaxMind ¬∑ For professional reference only ¬∑ Verify with current Act text</div>
</body></html>`);
  win.document.close();win.focus();setTimeout(()=>win.print(),400);
}
function downloadMsg(btn){
  const bubble=btn.closest('.msg-row').querySelector('.bubble');
  const text=bubble.innerText||bubble.textContent;
  const allBubbles=[...document.querySelectorAll('.bubble.user')];
  const query=allBubbles.length?allBubbles[allBubbles.length-1].innerText:'Tax Query';
  const date=new Date().toISOString().slice(0,10);
  const fname='TaxMind-'+query.slice(0,30).replace(/[^a-zA-Z0-9]/g,'-')+'-'+date+'.txt';
  const out='TaxMind ‚Äî Tax Intelligence\n'+'‚îÄ'.repeat(50)+'\nQuery: '+query+'\nDate: '+new Date().toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'})+'\n'+'‚îÄ'.repeat(50)+'\n\n'+text+'\n\n'+'‚îÄ'.repeat(50)+'\nGenerated by TaxMind ¬∑ Verify all section numbers with current Act text.';
  const a=document.createElement('a');
  a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(out);
  a.download=fname;a.click();
}
function showToast(msg,type='success'){
  const c={success:'var(--teal)',error:'var(--red)',info:'var(--gold)'};
  const t=document.createElement('div');t.className='toast';t.style.borderLeftColor=c[type];t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}
</script>
</body>
</html>
